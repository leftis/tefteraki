/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
/**
 * Creates a CKEDITOR.dom.range instance that can be used inside a specific
 * DOM Document.
 * @class Represents a delimited piece of content in a DOM Document.
 * It is contiguous in the sense that it can be characterized as selecting all
 * of the content between a pair of boundary-points.<br>
 * <br>
 * This class shares much of the W3C
 * <a href="http://www.w3.org/TR/DOM-Level-2-Traversal-Range/ranges.html">Document Object Model Range</a>
 * ideas and features, adding several range manipulation tools to it, but it's
 * not intended to be compatible with it.
 * @param {CKEDITOR.dom.document} document The document into which the range
 *		features will be available.
 * @example
 * // Create a range for the entire contents of the editor document body.
 * var range = new CKEDITOR.dom.range( editor.document );
 * range.selectNodeContents( editor.document.getBody() );
 * // Delete the contents.
 * range.deleteContents();
 */
CKEDITOR.dom.range=function(e){this.startContainer=null,this.startOffset=null,this.endContainer=null,this.endOffset=null,this.collapsed=!0,this.document=e},function(){function r(){var e=!1,t=CKEDITOR.dom.walker.whitespaces(),r=CKEDITOR.dom.walker.bookmark(!0),i=CKEDITOR.dom.walker.bogus();return function(s){return r(s)||t(s)?!0:i(s)&&!e?(e=!0,!0):s.type==CKEDITOR.NODE_TEXT&&(s.hasAscendant("pre")||CKEDITOR.tools.trim(s.getText()).length)?!1:s.type==CKEDITOR.NODE_ELEMENT&&!n[s.getName()]?!1:!0}}function s(e){var t=CKEDITOR.dom.walker.whitespaces(),n=CKEDITOR.dom.walker.bookmark(1);return function(r){return n(r)||t(r)?!0:!e&&i(r)||r.type==CKEDITOR.NODE_ELEMENT&&r.getName()in CKEDITOR.dtd.$removeEmpty}}function f(e){return!o(e)&&!u(e)}var e=function(e){e.collapsed=e.startContainer&&e.endContainer&&e.startContainer.equals(e.endContainer)&&e.startOffset==e.endOffset},t=function(e,t,n,r){e.optimizeBookmark();var i=e.startContainer,s=e.endContainer,o=e.startOffset,u=e.endOffset,a,f;s.type==CKEDITOR.NODE_TEXT?s=s.split(u):s.getChildCount()>0&&(u>=s.getChildCount()?(s=s.append(e.document.createText("")),f=!0):s=s.getChild(u)),i.type==CKEDITOR.NODE_TEXT?(i.split(o),i.equals(s)&&(s=i.getNext())):o?o>=i.getChildCount()?(i=i.append(e.document.createText("")),a=!0):i=i.getChild(o).getPrevious():(i=i.getFirst().insertBeforeMe(e.document.createText("")),a=!0);var l=i.getParents(),c=s.getParents(),h,p,d;for(h=0;h<l.length;h++){p=l[h],d=c[h];if(!p.equals(d))break}var v=n,m,g,y,b;for(var w=h;w<l.length;w++){m=l[w],v&&!m.equals(i)&&(g=v.append(m.clone())),y=m.getNext();while(y){if(y.equals(c[w])||y.equals(s))break;b=y.getNext(),t==2?v.append(y.clone(!0)):(y.remove(),t==1&&v.append(y)),y=b}v&&(v=g)}v=n;for(var E=h;E<c.length;E++){m=c[E],t>0&&!m.equals(s)&&(g=v.append(m.clone()));if(!l[E]||m.$.parentNode!=l[E].$.parentNode){y=m.getPrevious();while(y){if(y.equals(l[E])||y.equals(i))break;b=y.getPrevious(),t==2?v.$.insertBefore(y.$.cloneNode(!0),v.$.firstChild):(y.remove(),t==1&&v.$.insertBefore(y.$,v.$.firstChild)),y=b}}v&&(v=g)}if(t==2){var S=e.startContainer;S.type==CKEDITOR.NODE_TEXT&&(S.$.data+=S.$.nextSibling.data,S.$.parentNode.removeChild(S.$.nextSibling));var x=e.endContainer;x.type==CKEDITOR.NODE_TEXT&&x.$.nextSibling&&(x.$.data+=x.$.nextSibling.data,x.$.parentNode.removeChild(x.$.nextSibling))}else{if(p&&d&&(i.$.parentNode!=p.$.parentNode||s.$.parentNode!=d.$.parentNode)){var T=d.getIndex();a&&d.$.parentNode==i.$.parentNode&&T--;if(r&&p.type==CKEDITOR.NODE_ELEMENT){var N=CKEDITOR.dom.element.createFromHtml('<span data-cke-bookmark="1" style="display:none">&nbsp;</span>',e.document);N.insertAfter(p),p.mergeSiblings(!1),e.moveToBookmark({startNode:N})}else e.setStart(d.getParent(),T)}e.collapse(!0)}a&&i.remove(),f&&s.$.parentNode&&s.remove()},n={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},i=CKEDITOR.dom.walker.bogus(),o=new CKEDITOR.dom.walker.whitespaces,u=new CKEDITOR.dom.walker.bookmark,a=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/;CKEDITOR.dom.range.prototype={clone:function(){var e=new CKEDITOR.dom.range(this.document);return e.startContainer=this.startContainer,e.startOffset=this.startOffset,e.endContainer=this.endContainer,e.endOffset=this.endOffset,e.collapsed=this.collapsed,e},collapse:function(e){e?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset),this.collapsed=!0},cloneContents:function(){var e=new CKEDITOR.dom.documentFragment(this.document);return this.collapsed||t(this,2,e),e},deleteContents:function(e){if(this.collapsed)return;t(this,0,null,e)},extractContents:function(e){var n=new CKEDITOR.dom.documentFragment(this.document);return this.collapsed||t(this,1,n,e),n},createBookmark:function(e){var t,n,r,i,s=this.collapsed;return t=this.document.createElement("span"),t.data("cke-bookmark",1),t.setStyle("display","none"),t.setHtml("&nbsp;"),e&&(r="cke_bm_"+CKEDITOR.tools.getNextNumber(),t.setAttribute("id",r+(s?"C":"S"))),s||(n=t.clone(),n.setHtml("&nbsp;"),e&&n.setAttribute("id",r+"E"),i=this.clone(),i.collapse(),i.insertNode(n)),i=this.clone(),i.collapse(!0),i.insertNode(t),n?(this.setStartAfter(t),this.setEndBefore(n)):this.moveToPosition(t,CKEDITOR.POSITION_AFTER_END),{startNode:e?r+(s?"C":"S"):t,endNode:e?r+"E":n,serializable:e,collapsed:s}},createBookmark2:function(e){var t=this.startContainer,n=this.endContainer,r=this.startOffset,i=this.endOffset,s=this.collapsed,o,u;if(!t||!n)return{start:0,end:0};if(e){t.type==CKEDITOR.NODE_ELEMENT&&(o=t.getChild(r),o&&o.type==CKEDITOR.NODE_TEXT&&r>0&&o.getPrevious().type==CKEDITOR.NODE_TEXT&&(t=o,r=0),o&&o.type==CKEDITOR.NODE_ELEMENT&&(r=o.getIndex(1)));while(t.type==CKEDITOR.NODE_TEXT&&(u=t.getPrevious())&&u.type==CKEDITOR.NODE_TEXT)t=u,r+=u.getLength();if(!s){n.type==CKEDITOR.NODE_ELEMENT&&(o=n.getChild(i),o&&o.type==CKEDITOR.NODE_TEXT&&i>0&&o.getPrevious().type==CKEDITOR.NODE_TEXT&&(n=o,i=0),o&&o.type==CKEDITOR.NODE_ELEMENT&&(i=o.getIndex(1)));while(n.type==CKEDITOR.NODE_TEXT&&(u=n.getPrevious())&&u.type==CKEDITOR.NODE_TEXT)n=u,i+=u.getLength()}}return{start:t.getAddress(e),end:s?null:n.getAddress(e),startOffset:r,endOffset:i,normalized:e,collapsed:s,is2:!0}},moveToBookmark:function(e){if(e.is2){var t=this.document.getByAddress(e.start,e.normalized),n=e.startOffset,r=e.end&&this.document.getByAddress(e.end,e.normalized),i=e.endOffset;this.setStart(t,n),r?this.setEnd(r,i):this.collapse(!0)}else{var s=e.serializable,o=s?this.document.getById(e.startNode):e.startNode,u=s?this.document.getById(e.endNode):e.endNode;this.setStartBefore(o),o.remove(),u?(this.setEndBefore(u),u.remove()):this.collapse(!0)}},getBoundaryNodes:function(){var e=this.startContainer,t=this.endContainer,n=this.startOffset,r=this.endOffset,i;if(e.type==CKEDITOR.NODE_ELEMENT){i=e.getChildCount();if(i>n)e=e.getChild(n);else if(i<1)e=e.getPreviousSourceNode();else{e=e.$;while(e.lastChild)e=e.lastChild;e=new CKEDITOR.dom.node(e),e=e.getNextSourceNode()||e}}if(t.type==CKEDITOR.NODE_ELEMENT){i=t.getChildCount();if(i>r)t=t.getChild(r).getPreviousSourceNode(!0);else if(i<1)t=t.getPreviousSourceNode();else{t=t.$;while(t.lastChild)t=t.lastChild;t=new CKEDITOR.dom.node(t)}}return e.getPosition(t)&CKEDITOR.POSITION_FOLLOWING&&(e=t),{startNode:e,endNode:t}},getCommonAncestor:function(e,t){var n=this.startContainer,r=this.endContainer,i;return n.equals(r)?e&&n.type==CKEDITOR.NODE_ELEMENT&&this.startOffset==this.endOffset-1?i=n.getChild(this.startOffset):i=n:i=n.getCommonAncestor(r),t&&!i.is?i.getParent():i},optimize:function(){var e=this.startContainer,t=this.startOffset;e.type!=CKEDITOR.NODE_ELEMENT&&(t?t>=e.getLength()&&this.setStartAfter(e):this.setStartBefore(e)),e=this.endContainer,t=this.endOffset,e.type!=CKEDITOR.NODE_ELEMENT&&(t?t>=e.getLength()&&this.setEndAfter(e):this.setEndBefore(e))},optimizeBookmark:function(){var e=this.startContainer,t=this.endContainer;e.is&&e.is("span")&&e.data("cke-bookmark")&&this.setStartAt(e,CKEDITOR.POSITION_BEFORE_START),t&&t.is&&t.is("span")&&t.data("cke-bookmark")&&this.setEndAt(t,CKEDITOR.POSITION_AFTER_END)},trim:function(e,t){var n=this.startContainer,r=this.startOffset,i=this.collapsed;if((!e||i)&&n&&n.type==CKEDITOR.NODE_TEXT){if(!r)r=n.getIndex(),n=n.getParent();else if(r>=n.getLength())r=n.getIndex()+1,n=n.getParent();else{var s=n.split(r);r=n.getIndex()+1,n=n.getParent(),this.startContainer.equals(this.endContainer)?this.setEnd(s,this.endOffset-this.startOffset):n.equals(this.endContainer)&&(this.endOffset+=1)}this.setStart(n,r);if(i){this.collapse(!0);return}}var o=this.endContainer,u=this.endOffset;!t&&!i&&o&&o.type==CKEDITOR.NODE_TEXT&&(u?u>=o.getLength()?(u=o.getIndex()+1,o=o.getParent()):(o.split(u),u=o.getIndex()+1,o=o.getParent()):(u=o.getIndex(),o=o.getParent()),this.setEnd(o,u))},enlarge:function(e,t){switch(e){case CKEDITOR.ENLARGE_ELEMENT:if(this.collapsed)return;var n=this.getCommonAncestor(),r=this.document.getBody(),i,s,o,u,a,f=!1,l,c,h=this.startContainer,p=this.startOffset;h.type==CKEDITOR.NODE_TEXT?(p&&(h=!CKEDITOR.tools.trim(h.substring(0,p)).length&&h,f=!!h),h&&((u=h.getPrevious())||(o=h.getParent()))):(p&&(u=h.getChild(p-1)||h.getLast()),u||(o=h));while(o||u){if(o&&!u){!a&&o.equals(n)&&(a=!0);if(!r.contains(o))break;if(!f||o.getComputedStyle("display")!="inline")f=!1,a?i=o:this.setStartBefore(o);u=o.getPrevious()}while(u){l=!1;if(u.type==CKEDITOR.NODE_COMMENT){u=u.getPrevious();continue}if(u.type==CKEDITOR.NODE_TEXT)c=u.getText(),/[^\s\ufeff]/.test(c)&&(u=null),l=/[\s\ufeff]$/.test(c);else if((u.$.offsetWidth>0||t&&u.is("br"))&&!u.data("cke-bookmark"))if(f&&CKEDITOR.dtd.$removeEmpty[u.getName()]){c=u.getText();if(/[^\s\ufeff]/.test(c))u=null;else{var d=u.$.getElementsByTagName("*");for(var v=0,m;m=d[v++];)if(!CKEDITOR.dtd.$removeEmpty[m.nodeName.toLowerCase()]){u=null;break}}u&&(l=!!c.length)}else u=null;l&&(f?a?i=o:o&&this.setStartBefore(o):f=!0);if(u){var g=u.getPrevious();if(!o&&!g){o=u,u=null;break}u=g}else o=null}o&&(o=o.getParent())}h=this.endContainer,p=this.endOffset,o=u=null,a=f=!1,h.type==CKEDITOR.NODE_TEXT?(h=!CKEDITOR.tools.trim(h.substring(p)).length&&h,f=!h||!h.getLength(),h&&((u=h.getNext())||(o=h.getParent()))):(u=h.getChild(p),u||(o=h));while(o||u){if(o&&!u){!a&&o.equals(n)&&(a=!0);if(!r.contains(o))break;if(!f||o.getComputedStyle("display")!="inline")f=!1,a?s=o:o&&this.setEndAfter(o);u=o.getNext()}while(u){l=!1;if(u.type==CKEDITOR.NODE_TEXT)c=u.getText(),/[^\s\ufeff]/.test(c)&&(u=null),l=/^[\s\ufeff]/.test(c);else if(u.type==CKEDITOR.NODE_ELEMENT){if((u.$.offsetWidth>0||t&&u.is("br"))&&!u.data("cke-bookmark"))if(f&&CKEDITOR.dtd.$removeEmpty[u.getName()]){c=u.getText();if(/[^\s\ufeff]/.test(c))u=null;else{d=u.$.getElementsByTagName("*");for(v=0;m=d[v++];)if(!CKEDITOR.dtd.$removeEmpty[m.nodeName.toLowerCase()]){u=null;break}}u&&(l=!!c.length)}else u=null}else l=1;l&&f&&(a?s=o:this.setEndAfter(o));if(u){g=u.getNext();if(!o&&!g){o=u,u=null;break}u=g}else o=null}o&&(o=o.getParent())}i&&s&&(n=i.contains(s)?s:i,this.setStartBefore(n),this.setEndAfter(n));break;case CKEDITOR.ENLARGE_BLOCK_CONTENTS:case CKEDITOR.ENLARGE_LIST_ITEM_CONTENTS:var y=new CKEDITOR.dom.range(this.document);r=this.document.getBody(),y.setStartAt(r,CKEDITOR.POSITION_AFTER_START),y.setEnd(this.startContainer,this.startOffset);var b=new CKEDITOR.dom.walker(y),w,E,S=CKEDITOR.dom.walker.blockBoundary(e==CKEDITOR.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:null),x=function(e){var t=S(e);return t||(w=e),t},T=function(e){var t=x(e);return!t&&e.is&&e.is("br")&&(E=e),t};b.guard=x,o=b.lastBackward(),w=w||r,this.setStartAt(w,!w.is("br")&&(!o&&this.checkStartOfBlock()||o&&w.contains(o))?CKEDITOR.POSITION_AFTER_START:CKEDITOR.POSITION_AFTER_END);if(e==CKEDITOR.ENLARGE_LIST_ITEM_CONTENTS){var N=this.clone();b=new CKEDITOR.dom.walker(N);var C=CKEDITOR.dom.walker.whitespaces(),k=CKEDITOR.dom.walker.bookmark();b.evaluator=function(e){return!C(e)&&!k(e)};var L=b.previous();if(L&&L.type==CKEDITOR.NODE_ELEMENT&&L.is("br"))return}y=this.clone(),y.collapse(),y.setEndAt(r,CKEDITOR.POSITION_BEFORE_END),b=new CKEDITOR.dom.walker(y),b.guard=e==CKEDITOR.ENLARGE_LIST_ITEM_CONTENTS?T:x,w=null,o=b.lastForward(),w=w||r,this.setEndAt(w,!o&&this.checkEndOfBlock()||o&&w.contains(o)?CKEDITOR.POSITION_BEFORE_END:CKEDITOR.POSITION_BEFORE_START),E&&this.setEndAfter(E)}},shrink:function(e,t){if(!this.collapsed){e=e||CKEDITOR.SHRINK_TEXT;var n=this.clone(),r=this.startContainer,i=this.endContainer,s=this.startOffset,o=this.endOffset,u=this.collapsed,a=1,f=1;r&&r.type==CKEDITOR.NODE_TEXT&&(s?s>=r.getLength()?n.setStartAfter(r):(n.setStartBefore(r),a=0):n.setStartBefore(r)),i&&i.type==CKEDITOR.NODE_TEXT&&(o?o>=i.getLength()?n.setEndAfter(i):(n.setEndAfter(i),f=0):n.setEndBefore(i));var l=new CKEDITOR.dom.walker(n),c=CKEDITOR.dom.walker.bookmark();l.evaluator=function(t){return t.type==(e==CKEDITOR.SHRINK_ELEMENT?CKEDITOR.NODE_ELEMENT:CKEDITOR.NODE_TEXT)};var h;l.guard=function(t,n){return c(t)?!0:e==CKEDITOR.SHRINK_ELEMENT&&t.type==CKEDITOR.NODE_TEXT?!1:n&&t.equals(h)?!1:(!n&&t.type==CKEDITOR.NODE_ELEMENT&&(h=t),!0)};if(a){var p=l[e==CKEDITOR.SHRINK_ELEMENT?"lastForward":"next"]();p&&this.setStartAt(p,t?CKEDITOR.POSITION_AFTER_START:CKEDITOR.POSITION_BEFORE_START)}if(f){l.reset();var d=l[e==CKEDITOR.SHRINK_ELEMENT?"lastBackward":"previous"]();d&&this.setEndAt(d,t?CKEDITOR.POSITION_BEFORE_END:CKEDITOR.POSITION_AFTER_END)}return!!a||!!f}},insertNode:function(e){this.optimizeBookmark(),this.trim(!1,!0);var t=this.startContainer,n=this.startOffset,r=t.getChild(n);r?e.insertBefore(r):t.append(e),e.getParent().equals(this.endContainer)&&this.endOffset++,this.setStartBefore(e)},moveToPosition:function(e,t){this.setStartAt(e,t),this.collapse(!0)},selectNodeContents:function(e){this.setStart(e,0),this.setEnd(e,e.type==CKEDITOR.NODE_TEXT?e.getLength():e.getChildCount())},setStart:function(t,n){t.type==CKEDITOR.NODE_ELEMENT&&CKEDITOR.dtd.$empty[t.getName()]&&(n=t.getIndex(),t=t.getParent()),this.startContainer=t,this.startOffset=n,this.endContainer||(this.endContainer=t,this.endOffset=n),e(this)},setEnd:function(t,n){t.type==CKEDITOR.NODE_ELEMENT&&CKEDITOR.dtd.$empty[t.getName()]&&(n=t.getIndex()+1,t=t.getParent()),this.endContainer=t,this.endOffset=n,this.startContainer||(this.startContainer=t,this.startOffset=n),e(this)},setStartAfter:function(e){this.setStart(e.getParent(),e.getIndex()+1)},setStartBefore:function(e){this.setStart(e.getParent(),e.getIndex())},setEndAfter:function(e){this.setEnd(e.getParent(),e.getIndex()+1)},setEndBefore:function(e){this.setEnd(e.getParent(),e.getIndex())},setStartAt:function(t,n){switch(n){case CKEDITOR.POSITION_AFTER_START:this.setStart(t,0);break;case CKEDITOR.POSITION_BEFORE_END:t.type==CKEDITOR.NODE_TEXT?this.setStart(t,t.getLength()):this.setStart(t,t.getChildCount());break;case CKEDITOR.POSITION_BEFORE_START:this.setStartBefore(t);break;case CKEDITOR.POSITION_AFTER_END:this.setStartAfter(t)}e(this)},setEndAt:function(t,n){switch(n){case CKEDITOR.POSITION_AFTER_START:this.setEnd(t,0);break;case CKEDITOR.POSITION_BEFORE_END:t.type==CKEDITOR.NODE_TEXT?this.setEnd(t,t.getLength()):this.setEnd(t,t.getChildCount());break;case CKEDITOR.POSITION_BEFORE_START:this.setEndBefore(t);break;case CKEDITOR.POSITION_AFTER_END:this.setEndAfter(t)}e(this)},fixBlock:function(e,t){var n=this.createBookmark(),r=this.document.createElement(t);return this.collapse(e),this.enlarge(CKEDITOR.ENLARGE_BLOCK_CONTENTS),this.extractContents().appendTo(r),r.trim(),CKEDITOR.env.ie||r.appendBogus(),this.insertNode(r),this.moveToBookmark(n),r},splitBlock:function(e){var t=new CKEDITOR.dom.elementPath(this.startContainer),n=new CKEDITOR.dom.elementPath(this.endContainer),r=t.blockLimit,i=n.blockLimit,s=t.block,o=n.block,u=null;if(!r.equals(i))return null;e!="br"&&(s||(s=this.fixBlock(!0,e),o=(new CKEDITOR.dom.elementPath(this.endContainer)).block),o||(o=this.fixBlock(!1,e)));var a=s&&this.checkStartOfBlock(),f=o&&this.checkEndOfBlock();return this.deleteContents(),s&&s.equals(o)&&(f?(u=new CKEDITOR.dom.elementPath(this.startContainer),this.moveToPosition(o,CKEDITOR.POSITION_AFTER_END),o=null):a?(u=new CKEDITOR.dom.elementPath(this.startContainer),this.moveToPosition(s,CKEDITOR.POSITION_BEFORE_START),s=null):(o=this.splitElement(s),!CKEDITOR.env.ie&&!s.is("ul","ol")&&s.appendBogus())),{previousBlock:s,nextBlock:o,wasStartOfBlock:a,wasEndOfBlock:f,elementPath:u}},splitElement:function(e){if(!this.collapsed)return null;this.setEndAt(e,CKEDITOR.POSITION_BEFORE_END);var t=this.extractContents(),n=e.clone(!1);return t.appendTo(n),n.insertAfter(e),this.moveToPosition(e,CKEDITOR.POSITION_AFTER_END),n},checkBoundaryOfElement:function(e,t){var n=t==CKEDITOR.START,r=this.clone();r.collapse(n),r[n?"setStartAt":"setEndAt"](e,n?CKEDITOR.POSITION_AFTER_START:CKEDITOR.POSITION_BEFORE_END);var i=new CKEDITOR.dom.walker(r);return i.evaluator=s(n),i[n?"checkBackward":"checkForward"]()},checkStartOfBlock:function(){var e=this.startContainer,t=this.startOffset;if(CKEDITOR.env.ie&&t&&e.type==CKEDITOR.NODE_TEXT){var n=CKEDITOR.tools.ltrim(e.substring(0,t));a.test(n)&&this.trim(0,1)}var i=new CKEDITOR.dom.elementPath(this.startContainer),s=this.clone();s.collapse(!0),s.setStartAt(i.block||i.blockLimit,CKEDITOR.POSITION_AFTER_START);var o=new CKEDITOR.dom.walker(s);return o.evaluator=r(),o.checkBackward()},checkEndOfBlock:function(){var e=this.endContainer,t=this.endOffset;if(CKEDITOR.env.ie&&e.type==CKEDITOR.NODE_TEXT){var n=CKEDITOR.tools.rtrim(e.substring(t));a.test(n)&&this.trim(1,0)}var i=new CKEDITOR.dom.elementPath(this.endContainer),s=this.clone();s.collapse(!1),s.setEndAt(i.block||i.blockLimit,CKEDITOR.POSITION_BEFORE_END);var o=new CKEDITOR.dom.walker(s);return o.evaluator=r(),o.checkForward()},getPreviousNode:function(e,t,n){var r=this.clone();r.collapse(1),r.setStartAt(n||this.document.getBody(),CKEDITOR.POSITION_AFTER_START);var i=new CKEDITOR.dom.walker(r);return i.evaluator=e,i.guard=t,i.previous()},getNextNode:function(e,t,n){var r=this.clone();r.collapse(),r.setEndAt(n||this.document.getBody(),CKEDITOR.POSITION_BEFORE_END);var i=new CKEDITOR.dom.walker(r);return i.evaluator=e,i.guard=t,i.next()},checkReadOnly:function(){function e(e,t){while(e){if(e.type==CKEDITOR.NODE_ELEMENT){if(e.getAttribute("contentEditable")=="false"&&!e.data("cke-editable"))return 0;if(e.is("html")||e.getAttribute("contentEditable")=="true"&&(e.contains(t)||e.equals(t)))break}e=e.getParent()}return 1}return function(){var t=this.startContainer,n=this.endContainer;return!e(t,n)||!e(n,t)}}(),moveToElementEditablePosition:function(e,t){function n(e,n){var r;return e.type==CKEDITOR.NODE_ELEMENT&&e.isEditable(!1)&&(r=e[t?"getLast":"getFirst"](f)),!n&&!r&&(r=e[t?"getPrevious":"getNext"](f)),r}if(e.type==CKEDITOR.NODE_ELEMENT&&!e.isEditable(!1))return this.moveToPosition(e,t?CKEDITOR.POSITION_AFTER_END:CKEDITOR.POSITION_BEFORE_START),!0;var r=0;while(e){if(e.type==CKEDITOR.NODE_TEXT){t&&this.checkEndOfBlock()&&a.test(e.getText())?this.moveToPosition(e,CKEDITOR.POSITION_BEFORE_START):this.moveToPosition(e,t?CKEDITOR.POSITION_AFTER_END:CKEDITOR.POSITION_BEFORE_START),r=1;break}e.type==CKEDITOR.NODE_ELEMENT&&(e.isEditable()?(this.moveToPosition(e,t?CKEDITOR.POSITION_BEFORE_END:CKEDITOR.POSITION_AFTER_START),r=1):t&&e.is("br")&&this.checkEndOfBlock()&&this.moveToPosition(e,CKEDITOR.POSITION_BEFORE_START)),e=n(e,r)}return!!r},moveToElementEditStart:function(e){return this.moveToElementEditablePosition(e)},moveToElementEditEnd:function(e){return this.moveToElementEditablePosition(e,!0)},getEnclosedNode:function(){var e=this.clone();e.optimize();if(e.startContainer.type!=CKEDITOR.NODE_ELEMENT||e.endContainer.type!=CKEDITOR.NODE_ELEMENT)return null;var t=new CKEDITOR.dom.walker(e),n=CKEDITOR.dom.walker.bookmark(!0),r=CKEDITOR.dom.walker.whitespaces(!0),i=function(e){return r(e)&&n(e)};e.evaluator=i;var s=t.next();return t.reset(),s&&s.equals(t.previous())?s:null},getTouchedStartNode:function(){var e=this.startContainer;return this.collapsed||e.type!=CKEDITOR.NODE_ELEMENT?e:e.getChild(this.startOffset)||e},getTouchedEndNode:function(){var e=this.endContainer;return this.collapsed||e.type!=CKEDITOR.NODE_ELEMENT?e:e.getChild(this.endOffset-1)||e}}}(),CKEDITOR.POSITION_AFTER_START=1,CKEDITOR.POSITION_BEFORE_END=2,CKEDITOR.POSITION_BEFORE_START=3,CKEDITOR.POSITION_AFTER_END=4,CKEDITOR.ENLARGE_ELEMENT=1,CKEDITOR.ENLARGE_BLOCK_CONTENTS=2,CKEDITOR.ENLARGE_LIST_ITEM_CONTENTS=3,CKEDITOR.START=1,CKEDITOR.END=2,CKEDITOR.STARTEND=3,CKEDITOR.SHRINK_ELEMENT=1,CKEDITOR.SHRINK_TEXT=2;