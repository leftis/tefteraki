/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
/**
 * @fileOverview Defines the {@link CKEDITOR.editor} class, which represents an
 *		editor instance.
 */
(function(){function c(){var e,t=this._.commands,n=this.mode;if(!n)return;for(var r in t)e=t[r],e[e.startDisabled?"disable":this.readOnly&&!e.readOnly?"disable":e.modes[n]?"enable":"disable"]()}var e=0,t=function(){var n="editor"+ ++e;return CKEDITOR.instances&&CKEDITOR.instances[n]?t():n},n={},r=function(e){var t=e.config.customConfig;if(!t)return!1;t=CKEDITOR.getUrl(t);var i=n[t]||(n[t]={});return i.fn?(i.fn.call(e,e.config),(CKEDITOR.getUrl(e.config.customConfig)==t||!r(e))&&e.fireOnce("customConfigLoaded")):CKEDITOR.scriptLoader.load(t,function(){CKEDITOR.editorConfig?i.fn=CKEDITOR.editorConfig:i.fn=function(){},r(e)}),!0},i=function(e,t){e.on("customConfigLoaded",function(){if(t){if(t.on)for(var n in t.on)e.on(n,t.on[n]);CKEDITOR.tools.extend(e.config,t,!0),delete e.config.on}s(e)}),t&&t.customConfig!=undefined&&(e.config.customConfig=t.customConfig),r(e)||e.fireOnce("customConfigLoaded")},s=function(e){var t=e.config.skin.split(","),n=t[0],r=CKEDITOR.getUrl(t[1]||"_source/skins/"+n+"/");e.skinName=n,e.skinPath=r,e.skinClass="cke_skin_"+n,e.tabIndex=e.config.tabIndex||e.element.getAttribute("tabindex")||0,e.readOnly=!!e.config.readOnly||!!e.element.getAttribute("disabled"),e.fireOnce("configLoaded"),a(e)},o=function(e){CKEDITOR.lang.load(e.config.language,e.config.defaultLanguage,function(t,n){e.langCode=t,e.lang=CKEDITOR.tools.prototypedCopy(n),CKEDITOR.env.gecko&&CKEDITOR.env.version<10900&&e.lang.dir=="rtl"&&(e.lang.dir="ltr"),e.fire("langLoaded");var r=e.config;r.contentsLangDirection=="ui"&&(r.contentsLangDirection=e.lang.dir),u(e)})},u=function(e){var t=e.config,n=t.plugins,r=t.extraPlugins,i=t.removePlugins;if(r){var s=new RegExp("(?:^|,)(?:"+r.replace(/\s*,\s*/g,"|")+")(?=,|$)","g");n=n.replace(s,""),n+=","+r}i&&(s=new RegExp("(?:^|,)(?:"+i.replace(/\s*,\s*/g,"|")+")(?=,|$)","g"),n=n.replace(s,"")),CKEDITOR.env.air&&(n+=",adobeair"),CKEDITOR.plugins.load(n.split(","),function(t){var n=[],r=[],i=[];e.plugins=t;for(var s in t){var o=t[s],u=o.lang,a=CKEDITOR.plugins.getPath(s),l=null;o.path=a,u&&(l=CKEDITOR.tools.indexOf(u,e.langCode)>=0?e.langCode:u[0],!o.langEntries||!o.langEntries[l]?i.push(CKEDITOR.getUrl(a+"lang/"+l+".js")):(CKEDITOR.tools.extend(e.lang,o.langEntries[l]),l=null)),r.push(l),n.push(o)}CKEDITOR.scriptLoader.load(i,function(){var t=["beforeInit","init","afterInit"];for(var i=0;i<t.length;i++)for(var s=0;s<n.length;s++){var o=n[s];i===0&&r[s]&&o.lang&&CKEDITOR.tools.extend(e.lang,o.langEntries[r[s]]),o[t[i]]&&o[t[i]](e)}e.fire("pluginsLoaded"),f(e)})})},a=function(e){CKEDITOR.skins.load(e,"editor",function(){o(e)})},f=function(e){var t=e.config.theme;CKEDITOR.themes.load(t,function(){var n=e.theme=CKEDITOR.themes.get(t);n.path=CKEDITOR.themes.getPath(t),n.build(e),e.config.autoUpdateElement&&l(e)})},l=function(e){var t=e.element;if(e.elementMode==CKEDITOR.ELEMENT_MODE_REPLACE&&t.is("textarea")){var n=t.$.form&&new CKEDITOR.dom.element(t.$.form);if(n){function r(){e.updateElement()}n.on("submit",r),!n.$.submit.nodeName&&!n.$.submit.length&&(n.$.submit=CKEDITOR.tools.override(n.$.submit,function(t){return function(){e.updateElement(),t.apply?t.apply(this,arguments):t()}})),e.on("destroy",function(){n.removeListener("submit",r)})}}};CKEDITOR.editor.prototype._init=function(){var e=CKEDITOR.dom.element.get(this._.element),n=this._.instanceConfig;delete this._.element,delete this._.instanceConfig,this._.commands={},this._.styles=[],this.element=e,this.name=e&&this.elementMode==CKEDITOR.ELEMENT_MODE_REPLACE&&(e.getId()||e.getNameAtt())||t();if(this.name in CKEDITOR.instances)throw'[CKEDITOR.editor] The instance "'+this.name+'" already exists.';this.id=CKEDITOR.tools.getNextId(),this.config=CKEDITOR.tools.prototypedCopy(CKEDITOR.config),this.ui=new CKEDITOR.ui(this),this.focusManager=new CKEDITOR.focusManager(this),CKEDITOR.fire("instanceCreated",null,this),this.on("mode",c,null,null,1),this.on("readOnly",c,null,null,1),i(this,n)}})(),CKEDITOR.tools.extend(CKEDITOR.editor.prototype,{addCommand:function(e,t){return this._.commands[e]=new CKEDITOR.command(this,t)},addCss:function(e){this._.styles.push(e)},destroy:function(e){e||this.updateElement(),this.fire("destroy"),this.theme&&this.theme.destroy(this),CKEDITOR.remove(this),CKEDITOR.fire("instanceDestroyed",null,this)},execCommand:function(e,t){var n=this.getCommand(e),r={name:e,commandData:t,command:n};if(n&&n.state!=CKEDITOR.TRISTATE_DISABLED&&this.fire("beforeCommandExec",r)!==!0){r.returnValue=n.exec(r.commandData);if(!n.async&&this.fire("afterCommandExec",r)!==!0)return r.returnValue}return!1},getCommand:function(e){return this._.commands[e]},getData:function(){this.fire("beforeGetData");var e=this._.data;if(typeof e!="string"){var t=this.element;t&&this.elementMode==CKEDITOR.ELEMENT_MODE_REPLACE?e=t.is("textarea")?t.getValue():t.getHtml():e=""}return e={dataValue:e},this.fire("getData",e),e.dataValue},getSnapshot:function(){var e=this.fire("getSnapshot");if(typeof e!="string"){var t=this.element;t&&this.elementMode==CKEDITOR.ELEMENT_MODE_REPLACE&&(e=t.is("textarea")?t.getValue():t.getHtml())}return e},loadSnapshot:function(e){this.fire("loadSnapshot",e)},setData:function(e,t,n){t&&this.on("dataReady",function(e){e.removeListener(),t.call(e.editor)});var r={dataValue:e};!n&&this.fire("setData",r),this._.data=r.dataValue,!n&&this.fire("afterSetData",r)},setReadOnly:function(e){e=e==undefined||e,this.readOnly!=e&&(this.readOnly=e,this.fire("readOnly"))},insertHtml:function(e){this.fire("insertHtml",e)},insertText:function(e){this.fire("insertText",e)},insertElement:function(e){this.fire("insertElement",e)},checkDirty:function(){return this.mayBeDirty&&this._.previousValue!==this.getSnapshot()},resetDirty:function(){this.mayBeDirty&&(this._.previousValue=this.getSnapshot())},updateElement:function(){var e=this.element;if(e&&this.elementMode==CKEDITOR.ELEMENT_MODE_REPLACE){var t=this.getData();this.config.htmlEncodeOutput&&(t=CKEDITOR.tools.htmlEncode(t)),e.is("textarea")?e.setValue(t):e.setHtml(t)}}}),CKEDITOR.on("loaded",function(){var e=CKEDITOR.editor._pending;if(e){delete CKEDITOR.editor._pending;for(var t=0;t<e.length;t++)e[t]._init()}});