/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
(function(){function r(e){i(e),s(e)}function i(e){var t=e.editor,n=e.data.path;if(t.readOnly)return;var r=t.config.useComputedState,i;r=r===undefined||r,r||(i=o(n.lastElement)),i=i||n.block||n.blockLimit;if(i.is("body")){var s=t.getSelection().getRanges()[0].getEnclosedNode();s&&s.type==CKEDITOR.NODE_ELEMENT&&(i=s)}if(!i)return;var u=r?i.getComputedStyle("direction"):i.getStyle("direction")||i.getAttribute("dir");t.getCommand("bidirtl").setState(u=="rtl"?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF),t.getCommand("bidiltr").setState(u=="ltr"?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF)}function s(e){var t=e.editor,n=e.data.path.block||e.data.path.blockLimit;t.fire("contentDirChanged",n?n.getComputedStyle("direction"):t.lang.dir)}function o(e){while(e&&!(e.getName()in n||e.is("body"))){var t=e.getParent();if(!t)break;e=t}return e}function u(e,t,n,r){if(e.isReadOnly())return;CKEDITOR.dom.element.setMarker(r,e,"bidi_processed",1);var i=e;while((i=i.getParent())&&!i.is("body"))if(i.getCustomData("bidi_processed")){e.removeStyle("direction"),e.removeAttribute("dir");return}var s="useComputedState"in n.config?n.config.useComputedState:1,o=s?e.getComputedStyle("direction"):e.getStyle("direction")||e.hasAttribute("dir");if(o==t)return;e.removeStyle("direction"),s?(e.removeAttribute("dir"),t!=e.getComputedStyle("direction")&&e.setAttribute("dir",t)):e.setAttribute("dir",t),n.forceNextSelectionCheck();return}function a(e,t,n){var r=e.getCommonAncestor(!1,!0);e=e.clone(),e.enlarge(n==CKEDITOR.ENTER_BR?CKEDITOR.ENLARGE_LIST_ITEM_CONTENTS:CKEDITOR.ENLARGE_BLOCK_CONTENTS);if(e.checkBoundaryOfElement(r,CKEDITOR.START)&&e.checkBoundaryOfElement(r,CKEDITOR.END)){var i;while(r&&r.type==CKEDITOR.NODE_ELEMENT&&(i=r.getParent())&&i.getChildCount()==1&&!(r.getName()in t))r=i;return r.type==CKEDITOR.NODE_ELEMENT&&r.getName()in t&&r}}function f(n){return function(r){var i=r.getSelection(),s=r.config.enterMode,o=i.getRanges();if(o&&o.length){var f={},l=i.createBookmarks(),c=o.createIterator(),h,p=0;while(h=c.getNextRange(1)){var d=h.getEnclosedNode();if(!d||d&&!(d.type==CKEDITOR.NODE_ELEMENT&&d.getName()in t))d=a(h,e,s);d&&u(d,n,r,f);var v,m,g=new CKEDITOR.dom.walker(h),y=l[p].startNode,b=l[p++].endNode;g.evaluator=function(t){return!!(t.type==CKEDITOR.NODE_ELEMENT&&t.getName()in e&&(t.getName()!=(s==CKEDITOR.ENTER_P?"p":"div")||t.getParent().type!=CKEDITOR.NODE_ELEMENT||t.getParent().getName()!="blockquote")&&t.getPosition(y)&CKEDITOR.POSITION_FOLLOWING&&(t.getPosition(b)&CKEDITOR.POSITION_PRECEDING+CKEDITOR.POSITION_CONTAINS)==CKEDITOR.POSITION_PRECEDING)};while(m=g.next())u(m,n,r,f);v=h.createIterator(),v.enlargeBr=s!=CKEDITOR.ENTER_BR;while(m=v.getNextParagraph(s==CKEDITOR.ENTER_P?"p":"div"))u(m,n,r,f)}CKEDITOR.dom.element.clearAllMarkers(f),r.forceNextSelectionCheck(),i.selectBookmarks(l),r.focus()}}}function l(e){var t=e.getDocument().getBody().getParent();while(e){if(e.equals(t))return!1;e=e.getParent()}return!0}function c(e){var t=e==h.setAttribute,n=e==h.removeAttribute,r=/\bdirection\s*:\s*(.*?)\s*(:?$|;)/;return function(i,s){if(!this.getDocument().equals(CKEDITOR.document)){var o;if((i==(t||n?"dir":"direction")||i=="style"&&(n||r.test(s)))&&!l(this)){o=this.getDirection(1);var u=e.apply(this,arguments);if(o!=this.getDirection(1))return this.getDocument().fire("dirChanged",this),u}}return e.apply(this,arguments)}}var e={table:1,ul:1,ol:1,blockquote:1,div:1},t={},n={};CKEDITOR.tools.extend(t,e,{tr:1,p:1,div:1,li:1}),CKEDITOR.tools.extend(n,t,{td:1}),CKEDITOR.plugins.add("bidi",{requires:["styles","button"],init:function(e){var t=function(t,n,r,i){e.addCommand(r,new CKEDITOR.command(e,{exec:i})),e.ui.addButton(t,{label:n,command:r})},n=e.lang.bidi;t("BidiLtr",n.ltr,"bidiltr",f("ltr")),t("BidiRtl",n.rtl,"bidirtl",f("rtl")),e.on("selectionChange",r),e.on("contentDom",function(){e.document.on("dirChanged",function(t){e.fire("dirChanged",{node:t.data,dir:t.data.getDirection(1)})})})}});var h=CKEDITOR.dom.element.prototype,p=["setStyle","removeStyle","setAttribute","removeAttribute"];for(var d=0;d<p.length;d++)h[p[d]]=CKEDITOR.tools.override(h[p[d]],c)})();