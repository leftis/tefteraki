/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
/**
 * @file Blockquote.
 */
(function(){function e(e,t){var n=t.block||t.blockLimit;return!n||n.getName()=="body"?CKEDITOR.TRISTATE_OFF:n.getAscendant("blockquote",!0)?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF}function t(t){var n=t.editor;if(n.readOnly)return;var r=n.getCommand("blockquote");r.state=e(n,t.data.path),r.fire("state")}function n(e){for(var t=0,n=e.getChildCount(),r;t<n&&(r=e.getChild(t));t++)if(r.type==CKEDITOR.NODE_ELEMENT&&r.isBlockBoundary())return!1;return!0}var r={exec:function(e){var t=e.getCommand("blockquote").state,r=e.getSelection(),i=r&&r.getRanges(!0)[0];if(!i)return;var s=r.createBookmarks();if(CKEDITOR.env.ie){var o=s[0].startNode,u=s[0].endNode,a;if(o&&o.getParent().getName()=="blockquote"){a=o;while(a=a.getNext())if(a.type==CKEDITOR.NODE_ELEMENT&&a.isBlockBoundary()){o.move(a,!0);break}}if(u&&u.getParent().getName()=="blockquote"){a=u;while(a=a.getPrevious())if(a.type==CKEDITOR.NODE_ELEMENT&&a.isBlockBoundary()){u.move(a);break}}}var f=i.createIterator(),l;f.enlargeBr=e.config.enterMode!=CKEDITOR.ENTER_BR;if(t==CKEDITOR.TRISTATE_OFF){var c=[];while(l=f.getNextParagraph())c.push(l);if(c.length<1){var h=e.document.createElement(e.config.enterMode==CKEDITOR.ENTER_P?"p":"div"),p=s.shift();i.insertNode(h),h.append(new CKEDITOR.dom.text("ï»¿",e.document)),i.moveToBookmark(p),i.selectNodeContents(h),i.collapse(!0),p=i.createBookmark(),c.push(h),s.unshift(p)}var d=c[0].getParent(),v=[];for(var m=0;m<c.length;m++)l=c[m],d=d.getCommonAncestor(l.getParent());var g={table:1,tbody:1,tr:1,ol:1,ul:1};while(g[d.getName()])d=d.getParent();var y=null;while(c.length>0){l=c.shift();while(!l.getParent().equals(d))l=l.getParent();l.equals(y)||v.push(l),y=l}while(v.length>0){l=v.shift();if(l.getName()=="blockquote"){var b=new CKEDITOR.dom.documentFragment(e.document);while(l.getFirst())b.append(l.getFirst().remove()),c.push(b.getLast());b.replace(l)}else c.push(l)}var w=e.document.createElement("blockquote");w.insertBefore(c[0]);while(c.length>0)l=c.shift(),w.append(l)}else if(t==CKEDITOR.TRISTATE_ON){var E=[],S={};while(l=f.getNextParagraph()){var x=null,T=null;while(l.getParent()){if(l.getParent().getName()=="blockquote"){x=l.getParent(),T=l;break}l=l.getParent()}x&&T&&!T.getCustomData("blockquote_moveout")&&(E.push(T),CKEDITOR.dom.element.setMarker(S,T,"blockquote_moveout",!0))}CKEDITOR.dom.element.clearAllMarkers(S);var N=[],C=[];S={};while(E.length>0){var k=E.shift();w=k.getParent(),k.getPrevious()?k.getNext()?(k.breakParent(k.getParent()),C.push(k.getNext())):k.remove().insertAfter(w):k.remove().insertBefore(w),w.getCustomData("blockquote_processed")||(C.push(w),CKEDITOR.dom.element.setMarker(S,w,"blockquote_processed",!0)),N.push(k)}CKEDITOR.dom.element.clearAllMarkers(S);for(m=C.length-1;m>=0;m--)w=C[m],n(w)&&w.remove();if(e.config.enterMode==CKEDITOR.ENTER_BR){var L=!0;while(N.length){k=N.shift();if(k.getName()=="div"){b=new CKEDITOR.dom.documentFragment(e.document);var A=L&&k.getPrevious()&&(k.getPrevious().type!=CKEDITOR.NODE_ELEMENT||!k.getPrevious().isBlockBoundary());A&&b.append(e.document.createElement("br"));var O=k.getNext()&&(k.getNext().type!=CKEDITOR.NODE_ELEMENT||!k.getNext().isBlockBoundary());while(k.getFirst())k.getFirst().remove().appendTo(b);O&&b.append(e.document.createElement("br")),b.replace(k),L=!1}}}}r.selectBookmarks(s),e.focus()}};CKEDITOR.plugins.add("blockquote",{init:function(e){e.addCommand("blockquote",r),e.ui.addButton("Blockquote",{label:e.lang.blockquote,command:"blockquote"}),e.on("selectionChange",t)},requires:["domiterator"]})})();