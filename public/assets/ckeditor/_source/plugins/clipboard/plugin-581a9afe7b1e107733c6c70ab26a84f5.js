/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
/**
 * @file Clipboard support
 */
(function(){function s(e){e.cancel()}function o(e,t,n){var r=this.document;if(r.getById("cke_pastebin"))return;if(t=="text"&&e.data&&e.data.$.clipboardData){var i=e.data.$.clipboardData.getData("text/plain");if(i){e.data.preventDefault(),n(i);return}}var o=this.getSelection(),u=new CKEDITOR.dom.range(r),a=new CKEDITOR.dom.element(t=="text"?"textarea":CKEDITOR.env.webkit?"body":"div",r);a.setAttribute("id","cke_pastebin"),CKEDITOR.env.webkit&&a.append(r.createText("Â ")),r.getBody().append(a),a.setStyles({position:"absolute",top:o.getStartElement().getDocumentPosition().y+"px",width:"1px",height:"1px",overflow:"hidden"}),a.setStyle(this.config.contentsLangDirection=="ltr"?"left":"right","-1000px");var f=o.createBookmarks();this.on("selectionChange",s,null,null,0),t=="text"?a.$.focus():(u.setStartAt(a,CKEDITOR.POSITION_AFTER_START),u.setEndAt(a,CKEDITOR.POSITION_BEFORE_END),u.select(!0));var l=this;window.setTimeout(function(){l.document.getBody().focus(),l.removeListener("selectionChange",s),CKEDITOR.env.ie7Compat?(o.selectBookmarks(f),a.remove()):(a.remove(),o.selectBookmarks(f));var e;a=CKEDITOR.env.webkit&&(e=a.getFirst())&&e.is&&e.hasClass("Apple-style-span")?e:a,n(a["get"+(t=="text"?"Value":"Html")]())},0)}function u(e){if(!CKEDITOR.env.ie||CKEDITOR.env.quirks)return;var t=e.getSelection(),n;if(t.getType()==CKEDITOR.SELECTION_ELEMENT&&(n=t.getSelectedElement())){var r=t.getRanges()[0],i=e.document.createText("");i.insertBefore(n),r.setStartBefore(i),r.setEndAfter(n),t.selectRanges([r]),setTimeout(function(){n.getParent()&&(i.remove(),t.selectElement(n))},0)}}function l(e,t){var n;if(f&&e in{Paste:1,Cut:1})return CKEDITOR.TRISTATE_DISABLED;if(e=="Paste"){CKEDITOR.env.ie&&(a=1);try{n=t.document.$.queryCommandEnabled(e)||CKEDITOR.env.webkit}catch(r){}a=0}else{var i=t.getSelection(),s=i&&i.getRanges();n=i&&(s.length!=1||!s[0].collapsed)}return n?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED}function c(){if(this.mode!="wysiwyg")return;var e=l("Paste",this);this.getCommand("cut").setState(l("Cut",this)),this.getCommand("copy").setState(l("Copy",this)),this.getCommand("paste").setState(e),this.fire("pasteState",e)}var e=function(e,t){var n=e.document,r=n.getBody(),i=!1,s=function(){i=!0};return r.on(t,s),(CKEDITOR.env.version>7?n.$:n.$.selection.createRange()).execCommand(t),r.removeListener(t,s),i},t=CKEDITOR.env.ie?function(t,n){return e(t,n)}:function(e,t){try{return e.document.$.execCommand(t,!1,null)}catch(n){return!1}},n=function(e){this.type=e,this.canUndo=this.type=="cut",this.startDisabled=!0};n.prototype={exec:function(e,n){this.type=="cut"&&u(e);var r=t(e,this.type);return r||alert(e.lang.clipboard[this.type+"Error"]),r}};var r={canUndo:!1,exec:CKEDITOR.env.ie?function(t){t.focus();if(!t.document.getBody().fire("beforepaste")&&!e(t,"paste"))return t.fire("pasteDialog"),!1}:function(e){try{if(!e.document.getBody().fire("beforepaste")&&!e.document.$.execCommand("Paste",!1,null))throw 0}catch(t){return setTimeout(function(){e.fire("pasteDialog")},0),!1}}},i=function(e){if(this.mode!="wysiwyg")return;switch(e.data.keyCode){case CKEDITOR.CTRL+86:case CKEDITOR.SHIFT+45:var t=this.document.getBody();(CKEDITOR.env.opera||CKEDITOR.env.gecko)&&t.fire("paste");return;case CKEDITOR.CTRL+88:case CKEDITOR.SHIFT+46:var n=this;this.fire("saveSnapshot"),setTimeout(function(){n.fire("saveSnapshot")},0)}},a,f;CKEDITOR.plugins.add("clipboard",{requires:["dialog","htmldataprocessor"],init:function(e){function t(t,n,r,i){var s=e.lang[n];e.addCommand(n,r),e.ui.addButton(t,{label:s,command:n}),e.addMenuItems&&e.addMenuItem(n,{label:s,command:n,group:"clipboard",order:i})}e.on("paste",function(t){var n=t.data;n.html?e.insertHtml(n.html):n.text&&e.insertText(n.text),setTimeout(function(){e.fire("afterPaste")},0)},null,null,1e3),e.on("pasteDialog",function(t){setTimeout(function(){e.openDialog("paste")},0)}),e.on("pasteState",function(t){e.getCommand("paste").setState(t.data)}),t("Cut","cut",new n("cut"),1),t("Copy","copy",new n("copy"),4),t("Paste","paste",r,8),CKEDITOR.dialog.add("paste",CKEDITOR.getUrl(this.path+"dialogs/paste.js")),e.on("key",i,e),e.on("contentDom",function(){var t=e.document.getBody();t.on(CKEDITOR.env.ie?"beforepaste":"paste",function(t){if(a)return;var n=t.data&&t.data.$;if(CKEDITOR.env.ie&&n&&!n.ctrlKey)return;var r={mode:"html"};e.fire("beforePaste",r),o.call(e,t,r.mode,function(t){if(!(t=CKEDITOR.tools.trim(t.replace(/<span[^>]+data-cke-bookmark[^<]*?<\/span>/ig,""))))return;var n={};n[r.mode]=t,e.fire("paste",n)})}),CKEDITOR.env.ie&&(t.on("contextmenu",function(){a=1,setTimeout(function(){a=0},0)}),t.on("paste",function(t){e.document.getById("cke_pastebin")||(t.data.preventDefault(),a=0,r.exec(e))})),t.on("beforecut",function(){!a&&u(e)}),t.on("mouseup",function(){setTimeout(function(){c.call(e)},0)},e),t.on("keyup",c,e)}),e.on("selectionChange",function(t){f=t.data.selection.getRanges()[0].checkReadOnly(),c.call(e)}),e.contextMenu&&e.contextMenu.addListener(function(t,n){var r=n.getRanges()[0].checkReadOnly();return{cut:l("Cut",e),copy:l("Copy",e),paste:l("Paste",e)}})}})})();