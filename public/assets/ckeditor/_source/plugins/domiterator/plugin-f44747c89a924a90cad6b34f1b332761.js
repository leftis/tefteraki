/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
/**
 * @file DOM iterator, which iterates over list items, lines and paragraphs.
 */
CKEDITOR.plugins.add("domiterator"),function(){function e(e){if(arguments.length<1)return;this.range=e,this.forceBrBreak=0,this.enlargeBr=1,this.enforceRealBlocks=0,this._||(this._={})}function s(e,t,r){var i=e.getNextSourceNode(t,null,r);while(!n(i))i=i.getNextSourceNode(t,null,r);return i}var t=/^[\r\n\t ]+$/,n=CKEDITOR.dom.walker.bookmark(!1,!0),r=CKEDITOR.dom.walker.whitespaces(!0),i=function(e){return n(e)&&r(e)};e.prototype={getNextParagraph:function(e){var r,o,u,a,f,l;if(!this._.started){o=this.range.clone(),o.shrink(CKEDITOR.NODE_ELEMENT,!0),a=o.endContainer.hasAscendant("pre",!0)||o.startContainer.hasAscendant("pre",!0),o.enlarge(this.forceBrBreak&&!a||!this.enlargeBr?CKEDITOR.ENLARGE_LIST_ITEM_CONTENTS:CKEDITOR.ENLARGE_BLOCK_CONTENTS);if(!o.collapsed){var c=new CKEDITOR.dom.walker(o.clone()),h=CKEDITOR.dom.walker.bookmark(!0,!0);c.evaluator=h,this._.nextNode=c.next(),c=new CKEDITOR.dom.walker(o.clone()),c.evaluator=h;var p=c.previous();this._.lastNode=p.getNextSourceNode(!0);if(this._.lastNode&&this._.lastNode.type==CKEDITOR.NODE_TEXT&&!CKEDITOR.tools.trim(this._.lastNode.getText())&&this._.lastNode.getParent().isBlockBoundary()){var d=new CKEDITOR.dom.range(o.document);d.moveToPosition(this._.lastNode,CKEDITOR.POSITION_AFTER_END);if(d.checkEndOfBlock()){var v=new CKEDITOR.dom.elementPath(d.endContainer),m=v.block||v.blockLimit;this._.lastNode=m.getNextSourceNode(!0)}}this._.lastNode||(this._.lastNode=this._.docEndMarker=o.document.createText(""),this._.lastNode.insertAfter(p)),o=null}this._.started=1}var g=this._.nextNode;p=this._.lastNode,this._.nextNode=null;while(g){var y=0,b=g.hasAscendant("pre"),w=g.type!=CKEDITOR.NODE_ELEMENT,E=0;if(!w){var S=g.getName();if(g.isBlockBoundary(this.forceBrBreak&&!b&&{br:1})){if(S=="br")w=1;else if(!o&&!g.getChildCount()&&S!="hr"){r=g,u=g.equals(p);break}o&&(o.setEndAt(g,CKEDITOR.POSITION_BEFORE_START),S!="br"&&(this._.nextNode=g)),y=1}else{if(g.getFirst()){o||(o=new CKEDITOR.dom.range(this.range.document),o.setStartAt(g,CKEDITOR.POSITION_BEFORE_START)),g=g.getFirst();continue}w=1}}else g.type==CKEDITOR.NODE_TEXT&&t.test(g.getText())&&(w=0);w&&!o&&(o=new CKEDITOR.dom.range(this.range.document),o.setStartAt(g,CKEDITOR.POSITION_BEFORE_START)),u=(!y||w)&&g.equals(p);if(o&&!y)while(!g.getNext(i)&&!u){var x=g.getParent();if(x.isBlockBoundary(this.forceBrBreak&&!b&&{br:1})){y=1,w=0,u=u||x.equals(p),o.setEndAt(x,CKEDITOR.POSITION_BEFORE_END);break}g=x,w=1,u=g.equals(p),E=1}w&&o.setEndAt(g,CKEDITOR.POSITION_AFTER_END),g=s(g,E,p),u=!g;if(u||y&&o)break}if(!r){if(!o)return this._.docEndMarker&&this._.docEndMarker.remove(),this._.nextNode=null,null;var T=new CKEDITOR.dom.elementPath(o.startContainer),N=T.blockLimit,C={div:1,th:1,td:1};r=T.block;if(!r&&!this.enforceRealBlocks&&C[N.getName()]&&o.checkStartOfBlock()&&o.checkEndOfBlock())r=N;else if(!r||this.enforceRealBlocks&&r.getName()=="li")r=this.range.document.createElement(e||"p"),o.extractContents().appendTo(r),r.trim(),o.insertNode(r),f=l=!0;else if(r.getName()!="li"){if(!o.checkStartOfBlock()||!o.checkEndOfBlock()){r=r.clone(!1),o.extractContents().appendTo(r),r.trim();var k=o.splitBlock();f=!k.wasStartOfBlock,l=!k.wasEndOfBlock,o.insertNode(r)}}else u||(this._.nextNode=r.equals(p)?null:s(o.getBoundaryNodes().endNode,1,p))}if(f){var L=r.getPrevious();L&&L.type==CKEDITOR.NODE_ELEMENT&&(L.getName()=="br"?L.remove():L.getLast()&&L.getLast().$.nodeName.toLowerCase()=="br"&&L.getLast().remove())}if(l){var A=r.getLast();A&&A.type==CKEDITOR.NODE_ELEMENT&&A.getName()=="br"&&(CKEDITOR.env.ie||A.getPrevious(n)||A.getNext(n))&&A.remove()}return this._.nextNode||(this._.nextNode=u||r.equals(p)||!p?null:s(r,1,p)),r}},CKEDITOR.dom.range.prototype.createIterator=function(){return new e(this)}}();