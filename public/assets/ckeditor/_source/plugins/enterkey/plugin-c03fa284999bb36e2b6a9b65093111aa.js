/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
(function(){function i(e){return e.mode!="wysiwyg"?!1:s(e,e.config.shiftEnterMode,1)}function s(e,r,i){return i=e.config.forceEnterMode||i,e.mode!="wysiwyg"?!1:(r||(r=e.config.enterMode),setTimeout(function(){e.fire("saveSnapshot"),r==CKEDITOR.ENTER_BR?t(e,r,null,i):n(e,r,null,i),e.fire("saveSnapshot")},0),!0)}function o(e){var t=e.getSelection().getRanges(!0);for(var n=t.length-1;n>0;n--)t[n].deleteContents();return t[0]}CKEDITOR.plugins.add("enterkey",{requires:["keystrokes","indent"],init:function(e){e.addCommand("enter",{modes:{wysiwyg:1},editorFocus:!1,exec:function(e){s(e)}}),e.addCommand("shiftEnter",{modes:{wysiwyg:1},editorFocus:!1,exec:function(e){i(e)}});var t=e.keystrokeHandler.keystrokes;t[13]="enter",t[CKEDITOR.SHIFT+13]="shiftEnter"}}),CKEDITOR.plugins.enterkey={enterBlock:function(e,n,i,s){i=i||o(e);if(!i)return;var u=i.document,a=i.checkStartOfBlock(),f=i.checkEndOfBlock(),l=new CKEDITOR.dom.elementPath(i.startContainer),c=l.block;if(a&&f){if(c&&(c.is("li")||c.getParent().is("li"))){e.execCommand("outdent");return}if(c&&c.getParent().is("blockquote")){c.breakParent(c.getParent()),c.getPrevious().getFirst(CKEDITOR.dom.walker.invisible(1))||c.getPrevious().remove(),c.getNext().getFirst(CKEDITOR.dom.walker.invisible(1))||c.getNext().remove(),i.moveToElementEditStart(c),i.select();return}}else if(c&&c.is("pre")){if(!f){t(e,n,i,s);return}}else if(c&&CKEDITOR.dtd.$captionBlock[c.getName()]){t(e,n,i,s);return}var h=n==CKEDITOR.ENTER_DIV?"div":"p",p=i.splitBlock(h);if(!p)return;var d=p.previousBlock,v=p.nextBlock,m=p.wasStartOfBlock,g=p.wasEndOfBlock,y;v?(y=v.getParent(),y.is("li")&&(v.breakParent(y),v.move(v.getNext(),1))):d&&(y=d.getParent())&&y.is("li")&&(d.breakParent(y),y=d.getNext(),i.moveToElementEditStart(y),d.move(d.getPrevious()));if(!m&&!g)v.is("li")&&(y=v.getFirst(CKEDITOR.dom.walker.invisible(!0)))&&y.is&&y.is("ul","ol")&&(CKEDITOR.env.ie?u.createText(" "):u.createElement("br")).insertBefore(y),v&&i.moveToElementEditStart(v);else{var b,w;if(d){if(d.is("li")||!r.test(d.getName())&&!d.is("pre"))b=d.clone()}else v&&(b=v.clone());b?s&&!b.is("li")&&b.renameNode(h):y&&y.is("li")?b=y:(b=u.createElement(h),d&&(w=d.getDirection())&&b.setAttribute("dir",w));var E=p.elementPath;if(E)for(var S=0,x=E.elements.length;S<x;S++){var T=E.elements[S];if(T.equals(E.block)||T.equals(E.blockLimit))break;CKEDITOR.dtd.$removeEmpty[T.getName()]&&(T=T.clone(),b.moveChildren(T),b.append(T))}CKEDITOR.env.ie||b.appendBogus(),b.getParent()||i.insertNode(b),b.is("li")&&b.removeAttribute("value"),CKEDITOR.env.ie&&m&&(!g||!d.getChildCount())&&(i.moveToElementEditStart(g?d:b),i.select()),i.moveToElementEditStart(m&&!g?v:b)}if(!CKEDITOR.env.ie)if(v){var N=u.createElement("span");N.setHtml("&nbsp;"),i.insertNode(N),N.scrollIntoView(),i.deleteContents()}else b.scrollIntoView();i.select()},enterBr:function(e,t,i,s){i=i||o(e);if(!i)return;var u=i.document,a=t==CKEDITOR.ENTER_DIV?"div":"p",f=i.checkEndOfBlock(),l=new CKEDITOR.dom.elementPath(e.getSelection().getStartElement()),c=l.block,h=c&&l.block.getName(),p=!1;if(!s&&h=="li"){n(e,t,i,s);return}if(!s&&f&&r.test(h)){var d,v;(v=c.getDirection())?(d=u.createElement("div"),d.setAttribute("dir",v),d.insertAfter(c),i.setStart(d,0)):(u.createElement("br").insertAfter(c),CKEDITOR.env.gecko&&u.createText("").insertAfter(c),i.setStartAt(c.getNext(),CKEDITOR.env.ie?CKEDITOR.POSITION_BEFORE_START:CKEDITOR.POSITION_AFTER_START))}else{var m;p=h=="pre",p&&!CKEDITOR.env.gecko?m=u.createText(CKEDITOR.env.ie?"\r":"\n"):m=u.createElement("br"),i.deleteContents(),i.insertNode(m);if(CKEDITOR.env.ie)i.setStartAt(m,CKEDITOR.POSITION_AFTER_END);else{u.createText("﻿").insertAfter(m),f&&m.getParent().appendBogus(),m.getNext().$.nodeValue="",i.setStartAt(m.getNext(),CKEDITOR.POSITION_AFTER_START);var g=null;CKEDITOR.env.gecko?g=u.createElement("br"):(g=u.createElement("span"),g.setHtml("&nbsp;")),g.insertBefore(m.getNext()),g.scrollIntoView(),g.remove()}}i.collapse(!0),i.select(p)}};var e=CKEDITOR.plugins.enterkey,t=e.enterBr,n=e.enterBlock,r=/^h[1-6]$/})();