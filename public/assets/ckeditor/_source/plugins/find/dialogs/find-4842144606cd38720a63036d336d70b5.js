/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
(function(){function t(t){return t.type==CKEDITOR.NODE_TEXT&&t.getLength()>0&&(!e||!t.isReadOnly())}function n(e){return e.type!=CKEDITOR.NODE_ELEMENT||!e.isBlockBoundary(CKEDITOR.tools.extend({},CKEDITOR.dtd.$empty,CKEDITOR.dtd.$nonEditable))}function o(e){var t,n,r,o;t=e==="find"?1:0,n=1-t;var u,a=s.length;for(u=0;u<a;u++)r=this.getContentElement(i[t],s[u][t]),o=this.getContentElement(i[n],s[u][n]),o.setValue(r.getValue())}var e,r=function(){return{textNode:this.textNode,offset:this.offset,character:this.textNode?this.textNode.getText().charAt(this.offset):null,hitMatchBoundary:this._.matchBoundary}},i=["find","replace"],s=[["txtFindFind","txtFindReplace"],["txtFindCaseChk","txtReplaceCaseChk"],["txtFindWordChk","txtReplaceWordChk"],["txtFindCyclic","txtReplaceCyclic"]],u=function(i,s){function l(e,t){var n=new CKEDITOR.dom.range;return n.setStart(e.textNode,t?e.offset:e.offset+1),n.setEndAt(i.document.getBody(),CKEDITOR.POSITION_BEFORE_END),n}function c(e){var t=new CKEDITOR.dom.range;return t.setStartAt(i.document.getBody(),CKEDITOR.POSITION_AFTER_START),t.setEnd(e.textNode,e.offset),t}function b(e){var t,n=i.getSelection(),r=i.document.getBody();return n&&!e?(t=n.getRanges()[0].clone(),t.collapse(!0)):(t=new CKEDITOR.dom.range,t.setStartAt(r,CKEDITOR.POSITION_AFTER_START)),t.setEndAt(r,CKEDITOR.POSITION_BEFORE_END),t}var u=new CKEDITOR.style(CKEDITOR.tools.extend({attributes:{"data-cke-highlight":1},fullMatch:1,ignoreReadonly:1,childRule:function(){return 0}},i.config.find_highlight,!0)),a=function(e,r){var i=this,s=new CKEDITOR.dom.walker(e);s.guard=r?n:function(e){!n(e)&&(i._.matchBoundary=!0)},s.evaluator=t,s.breakOnFalse=1,e.startContainer.type==CKEDITOR.NODE_TEXT&&(this.textNode=e.startContainer,this.offset=e.startOffset-1),this._={matchWord:r,walker:s,matchBoundary:!1}};a.prototype={next:function(){return this.move()},back:function(){return this.move(!0)},move:function(e){var t=this.textNode;if(t===null)return r.call(this);this._.matchBoundary=!1;if(t&&e&&this.offset>0)return this.offset--,r.call(this);if(t&&this.offset<t.getLength()-1)return this.offset++,r.call(this);t=null;while(!t){t=this._.walker[e?"previous":"next"].call(this._.walker);if(this._.matchWord&&!t||this._.walker._.end)break}return this.textNode=t,t?this.offset=e?t.getLength()-1:0:this.offset=0,r.call(this)}};var f=function(e,t){this._={walker:e,cursors:[],rangeLength:t,highlightRange:null,isMatched:0}};f.prototype={toDomRange:function(){var e=new CKEDITOR.dom.range(i.document),t=this._.cursors;if(t.length<1){var n=this._.walker.textNode;if(!n)return null;e.setStartAfter(n)}else{var r=t[0],s=t[t.length-1];e.setStart(r.textNode,r.offset),e.setEnd(s.textNode,s.offset+1)}return e},updateFromDomRange:function(e){var t,n=new a(e);this._.cursors=[];do t=n.next(),t.character&&this._.cursors.push(t);while(t.character);this._.rangeLength=this._.cursors.length},setMatched:function(){this._.isMatched=!0},clearMatched:function(){this._.isMatched=!1},isMatched:function(){return this._.isMatched},highlight:function(){if(this._.cursors.length<1)return;this._.highlightRange&&this.removeHighlight();var e=this.toDomRange(),t=e.createBookmark();u.applyToRange(e),e.moveToBookmark(t),this._.highlightRange=e;var n=e.startContainer;n.type!=CKEDITOR.NODE_ELEMENT&&(n=n.getParent()),n.scrollIntoView(),this.updateFromDomRange(e)},removeHighlight:function(){if(!this._.highlightRange)return;var e=this._.highlightRange.createBookmark();u.removeFromRange(this._.highlightRange),this._.highlightRange.moveToBookmark(e),this.updateFromDomRange(this._.highlightRange),this._.highlightRange=null},isReadOnly:function(){return this._.highlightRange?this._.highlightRange.startContainer.isReadOnly():0},moveBack:function(){var e=this._.walker.back(),t=this._.cursors;return e.hitMatchBoundary&&(this._.cursors=t=[]),t.unshift(e),t.length>this._.rangeLength&&t.pop(),e},moveNext:function(){var e=this._.walker.next(),t=this._.cursors;return e.hitMatchBoundary&&(this._.cursors=t=[]),t.push(e),t.length>this._.rangeLength&&t.shift(),e},getEndCharacter:function(){var e=this._.cursors;return e.length<1?null:e[e.length-1].character},getNextCharacterRange:function(e){var t,n,r=this._.cursors;return(t=r[r.length-1])&&t.textNode?n=new a(l(t)):n=this._.walker,new f(n,e)},getCursors:function(){return this._.cursors}};var h=0,p=1,d=2,v=function(e,t){var n=[-1];t&&(e=e.toLowerCase());for(var r=0;r<e.length;r++){n.push(n[r]+1);while(n[r+1]>0&&e.charAt(r)!=e.charAt(n[r+1]-1))n[r+1]=n[n[r+1]-1]+1}this._={overlap:n,state:0,ignoreCase:!!t,pattern:e}};v.prototype={feedCharacter:function(e){this._.ignoreCase&&(e=e.toLowerCase());for(;;){if(e==this._.pattern.charAt(this._.state))return this._.state++,this._.state==this._.pattern.length?(this._.state=0,d):p;if(!this._.state)return h;this._.state=this._.overlap[this._.state]}return null},reset:function(){this._.state=0}};var m=/[.,"'?!;: \u0085\u00a0\u1680\u280e\u2028\u2029\u202f\u205f\u3000]/,g=function(e){if(!e)return!0;var t=e.charCodeAt(0);return t>=9&&t<=13||t>=8192&&t<=8202||m.test(e)},y={searchRange:null,matchRange:null,find:function(e,t,n,r,i,s){this.matchRange?(this.matchRange.removeHighlight(),this.matchRange=this.matchRange.getNextCharacterRange(e.length)):this.matchRange=new f(new a(this.searchRange),e.length);var o=new v(e,!t),u=h,p="%";while(p!==null){this.matchRange.moveNext();while(p=this.matchRange.getEndCharacter()){u=o.feedCharacter(p);if(u==d)break;this.matchRange.moveNext().hitMatchBoundary&&o.reset()}if(u==d){if(n){var m=this.matchRange.getCursors(),y=m[m.length-1],w=m[0],E=c(w),S=l(y);E.trim(),S.trim();var x=new a(E,!0),T=new a(S,!0);if(!g(x.back().character)||!g(T.next().character))continue}return this.matchRange.setMatched(),i!==!1&&this.matchRange.highlight(),!0}}return this.matchRange.clearMatched(),this.matchRange.removeHighlight(),r&&!s?(this.searchRange=b(1),this.matchRange=null,arguments.callee.apply(this,Array.prototype.slice.call(arguments).concat([!0]))):!1},replaceCounter:0,replace:function(t,n,r,s,o,u,a){e=1;var f=0;if(this.matchRange&&this.matchRange.isMatched()&&!this.matchRange._.isReplaced&&!this.matchRange.isReadOnly()){this.matchRange.removeHighlight();var l=this.matchRange.toDomRange(),c=i.document.createText(r);if(!a){var h=i.getSelection();h.selectRanges([l]),i.fire("saveSnapshot")}l.deleteContents(),l.insertNode(c),a||(h.selectRanges([l]),i.fire("saveSnapshot")),this.matchRange.updateFromDomRange(l),a||this.matchRange.highlight(),this.matchRange._.isReplaced=!0,this.replaceCounter++,f=1}else f=this.find(n,s,o,u,!a);return e=0,f}},w=i.lang.findAndReplace;return{title:w.title,resizable:CKEDITOR.DIALOG_RESIZE_NONE,minWidth:350,minHeight:170,buttons:[CKEDITOR.dialog.cancelButton],contents:[{id:"find",label:w.find,title:w.find,accessKey:"",elements:[{type:"hbox",widths:["230px","90px"],children:[{type:"text",id:"txtFindFind",label:w.findWhat,isChanged:!1,labelLayout:"horizontal",accessKey:"F"},{type:"button",id:"btnFind",align:"left",style:"width:100%",label:w.find,onClick:function(){var e=this.getDialog();y.find(e.getValueOf("find","txtFindFind"),e.getValueOf("find","txtFindCaseChk"),e.getValueOf("find","txtFindWordChk"),e.getValueOf("find","txtFindCyclic"))||alert(w.notFoundMsg)}}]},{type:"fieldset",label:CKEDITOR.tools.htmlEncode(w.findOptions),style:"margin-top:29px",children:[{type:"vbox",padding:0,children:[{type:"checkbox",id:"txtFindCaseChk",isChanged:!1,label:w.matchCase},{type:"checkbox",id:"txtFindWordChk",isChanged:!1,label:w.matchWord},{type:"checkbox",id:"txtFindCyclic",isChanged:!1,"default":!0,label:w.matchCyclic}]}]}]},{id:"replace",label:w.replace,accessKey:"M",elements:[{type:"hbox",widths:["230px","90px"],children:[{type:"text",id:"txtFindReplace",label:w.findWhat,isChanged:!1,labelLayout:"horizontal",accessKey:"F"},{type:"button",id:"btnFindReplace",align:"left",style:"width:100%",label:w.replace,onClick:function(){var e=this.getDialog();y.replace(e,e.getValueOf("replace","txtFindReplace"),e.getValueOf("replace","txtReplace"),e.getValueOf("replace","txtReplaceCaseChk"),e.getValueOf("replace","txtReplaceWordChk"),e.getValueOf("replace","txtReplaceCyclic"))||alert(w.notFoundMsg)}}]},{type:"hbox",widths:["230px","90px"],children:[{type:"text",id:"txtReplace",label:w.replaceWith,isChanged:!1,labelLayout:"horizontal",accessKey:"R"},{type:"button",id:"btnReplaceAll",align:"left",style:"width:100%",label:w.replaceAll,isChanged:!1,onClick:function(){var e=this.getDialog(),t;y.replaceCounter=0,y.searchRange=b(1),y.matchRange&&(y.matchRange.removeHighlight(),y.matchRange=null),i.fire("saveSnapshot");while(y.replace(e,e.getValueOf("replace","txtFindReplace"),e.getValueOf("replace","txtReplace"),e.getValueOf("replace","txtReplaceCaseChk"),e.getValueOf("replace","txtReplaceWordChk"),!1,!0));y.replaceCounter?(alert(w.replaceSuccessMsg.replace(/%1/,y.replaceCounter)),i.fire("saveSnapshot")):alert(w.notFoundMsg)}}]},{type:"fieldset",label:CKEDITOR.tools.htmlEncode(w.findOptions),children:[{type:"vbox",padding:0,children:[{type:"checkbox",id:"txtReplaceCaseChk",isChanged:!1,label:w.matchCase},{type:"checkbox",id:"txtReplaceWordChk",isChanged:!1,label:w.matchWord},{type:"checkbox",id:"txtReplaceCyclic",isChanged:!1,"default":!0,label:w.matchCyclic}]}]}]}],onLoad:function(){var e=this,t,n,r=0;this.on("hide",function(){r=0}),this.on("show",function(){r=1}),this.selectPage=CKEDITOR.tools.override(this.selectPage,function(i){return function(s){i.call(e,s);var u=e._.tabs[s],a,f,l;f=s==="find"?"txtFindFind":"txtFindReplace",l=s==="find"?"txtFindWordChk":"txtReplaceWordChk",t=e.getContentElement(s,f),n=e.getContentElement(s,l),u.initialized||(a=CKEDITOR.document.getById(t._.inputId),u.initialized=!0),r&&o.call(this,s)}})},onShow:function(){y.searchRange=b();var e=this.getParentEditor().getSelection().getSelectedText(),t=s=="find"?"txtFindFind":"txtFindReplace",n=this.getContentElement(s,t);n.setValue(e),n.select(),this.selectPage(s),this[(s=="find"&&this._.editor.readOnly?"hide":"show")+"Page"]("replace")},onHide:function(){var e;y.matchRange&&y.matchRange.isMatched()&&(y.matchRange.removeHighlight(),i.focus(),e=y.matchRange.toDomRange(),e&&i.getSelection().selectRanges([e])),delete y.matchRange},onFocus:function(){return s=="replace"?this.getContentElement("replace","txtFindReplace"):this.getContentElement("find","txtFindFind")}}};CKEDITOR.dialog.add("find",function(e){return u(e,"find")}),CKEDITOR.dialog.add("replace",function(e){return u(e,"replace")})})();