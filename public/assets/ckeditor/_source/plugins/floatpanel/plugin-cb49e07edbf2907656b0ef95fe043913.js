/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
CKEDITOR.plugins.add("floatpanel",{requires:["panel"]}),function(){function n(t,n,r,i,s){var o=CKEDITOR.tools.genKey(n.getUniqueId(),r.getUniqueId(),t.skinName,t.lang.dir,t.uiColor||"",i.css||"",s||""),u=e[o];return u||(u=e[o]=new CKEDITOR.ui.panel(n,i),u.element=r.append(CKEDITOR.dom.element.createFromHtml(u.renderHtml(t),n)),u.element.setStyles({display:"none",position:"absolute"})),u}var e={},t=!1;CKEDITOR.ui.floatPanel=CKEDITOR.tools.createClass({$:function(e,t,r,i){r.forceIFrame=1;var s=t.getDocument(),o=n(e,s,t,r,i||0),u=o.element,a=u.getFirst().getFirst();u.disableContextMenu(),this.element=u,this._={editor:e,panel:o,parentElement:t,definition:r,document:s,iframe:a,children:[],dir:e.lang.dir},e.on("mode",function(){this.hide()},this)},proto:{addBlock:function(e,t){return this._.panel.addBlock(e,t)},addListBlock:function(e,t){return this._.panel.addListBlock(e,t)},getBlock:function(e){return this._.panel.getBlock(e)},showBlock:function(e,n,r,i,s){var o=this._.panel,u=o.showBlock(e);this.allowBlur(!1),t=1,this._.returnFocus=this._.editor.focusManager.hasFocus?this._.editor:new CKEDITOR.dom.element(CKEDITOR.document.$.activeElement);var a=this.element,f=this._.iframe,l=this._.definition,c=n.getDocumentPosition(a.getDocument()),h=this._.dir=="rtl",p=c.x+(i||0),d=c.y+(s||0);!h||r!=1&&r!=4?!h&&(r==2||r==3)&&(p+=n.$.offsetWidth-1):p+=n.$.offsetWidth;if(r==3||r==4)d+=n.$.offsetHeight-1;this._.panel._.offsetParentId=n.getId(),a.setStyles({top:d+"px",left:0,display:""}),a.setOpacity(0),a.getFirst().removeStyle("width");if(!this._.blurSet){var v=CKEDITOR.env.ie?f:new CKEDITOR.dom.window(f.$.contentWindow);CKEDITOR.event.useCapture=!0,v.on("blur",function(e){if(!this.allowBlur())return;var n=e.data.getTarget();if(n.getName&&n.getName()!="iframe")return;this.visible&&!this._.activeChild&&!t&&(delete this._.returnFocus,this.hide())},this),v.on("focus",function(){this._.focused=!0,this.hideChild(),this.allowBlur(!0)},this),CKEDITOR.event.useCapture=!1,this._.blurSet=1}o.onEscape=CKEDITOR.tools.bind(function(e){if(this.onEscape&&this.onEscape(e)===!1)return!1},this),CKEDITOR.tools.setTimeout(function(){var e=CKEDITOR.tools.bind(function(){var e=a.getFirst();if(u.autoSize){var t=u.element.$;if(CKEDITOR.env.gecko||CKEDITOR.env.opera)t=t.parentNode;CKEDITOR.env.ie&&(t=t.document.body);var n=t.scrollWidth;CKEDITOR.env.ie&&CKEDITOR.env.quirks&&n>0&&(n+=(e.$.offsetWidth||0)-(e.$.clientWidth||0)+3),n+=4,e.setStyle("width",n+"px"),u.element.addClass("cke_frameLoaded");var r=u.element.$.scrollHeight;CKEDITOR.env.ie&&CKEDITOR.env.quirks&&r>0&&(r+=(e.$.offsetHeight||0)-(e.$.clientHeight||0)+3),e.setStyle("height",r+"px"),o._.currentBlock.element.setStyle("display","none").removeStyle("display")}else e.removeStyle("height");h&&(p-=a.$.offsetWidth),a.setStyle("left",p+"px");var i=o.element,s=i.getWindow(),f=a.$.getBoundingClientRect(),l=s.getViewPaneSize(),c=f.width||f.right-f.left,v=f.height||f.bottom-f.top,m=h?f.right:l.width-f.left,g=h?l.width-f.right:f.left;h?m<c&&(g>c?p+=c:l.width>c?p-=f.left:p=p-f.right+l.width):m<c&&(g>c?p-=c:l.width>c?p=p-f.right+l.width:p-=f.left);var y=l.height-f.top,b=f.top;y<v&&(b>v?d-=v:l.height>v?d=d-f.bottom+l.height:d-=f.top);if(CKEDITOR.env.ie){var w=new CKEDITOR.dom.element(a.$.offsetParent),E=w;E.getName()=="html"&&(E=E.getDocument().getBody()),E.getComputedStyle("direction")=="rtl"&&(CKEDITOR.env.ie8Compat?p-=a.getDocument().getDocumentElement().$.scrollLeft*2:p-=w.$.scrollWidth-w.$.clientWidth)}var S=a.getFirst(),x;(x=S.getCustomData("activePanel"))&&x.onHide&&x.onHide.call(this,1),S.setCustomData("activePanel",this),a.setStyles({top:d+"px",left:p+"px"}),a.setOpacity(1)},this);o.isLoaded?e():o.onLoad=e,CKEDITOR.tools.setTimeout(function(){f.$.contentWindow.focus(),this.allowBlur(!0)},0,this)},CKEDITOR.env.air?200:0,this),this.visible=1,this.onShow&&this.onShow.call(this),t=0},hide:function(e){if(this.visible&&(!this.onHide||this.onHide.call(this)!==!0)){this.hideChild(),CKEDITOR.env.gecko&&this._.iframe.getFrameDocument().$.activeElement.blur(),this.element.setStyle("display","none"),this.visible=0,this.element.getFirst().removeCustomData("activePanel");var t=e!==!1&&this._.returnFocus;t&&(CKEDITOR.env.webkit&&t.type&&t.getWindow().$.focus(),t.focus())}},allowBlur:function(e){var t=this._.panel;return e!=undefined&&(t.allowBlur=e),t.allowBlur},showAsChild:function(e,t,n,r,i,s){if(this._.activeChild==e&&e._.panel._.offsetParentId==n.getId())return;this.hideChild(),e.onHide=CKEDITOR.tools.bind(function(){CKEDITOR.tools.setTimeout(function(){this._.focused||this.hide()},0,this)},this),this._.activeChild=e,this._.focused=!1,e.showBlock(t,n,r,i,s),(CKEDITOR.env.ie7Compat||CKEDITOR.env.ie8&&CKEDITOR.env.ie6Compat)&&setTimeout(function(){e.element.getChild(0).$.style.cssText+=""},100)},hideChild:function(){var e=this._.activeChild;e&&(delete e.onHide,delete e._.returnFocus,delete this._.activeChild,e.hide())}}}),CKEDITOR.on("instanceDestroyed",function(){var t=CKEDITOR.tools.isEmpty(CKEDITOR.instances);for(var n in e){var r=e[n];t?r.destroy():r.element.hide()}t&&(e={})})}();