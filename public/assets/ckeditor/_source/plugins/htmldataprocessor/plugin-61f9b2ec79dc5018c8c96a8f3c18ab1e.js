/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
(function(){function n(e){var t=e.children.length,n=e.children[t-1];while(n&&n.type==CKEDITOR.NODE_TEXT&&!CKEDITOR.tools.trim(n.value))n=e.children[--t];return n}function r(e){var t=e.parent;return t?CKEDITOR.tools.indexOf(t.children,e):-1}function i(t,r){var i=t.children,s=n(t);s&&((r||!CKEDITOR.env.ie)&&s.type==CKEDITOR.NODE_ELEMENT&&s.name=="br"&&i.pop(),s.type==CKEDITOR.NODE_TEXT&&e.test(s.value)&&i.pop())}function s(e,t,r){if(!t&&(!r||typeof r=="function"&&r(e)===!1))return!1;if(t&&CKEDITOR.env.ie&&(document.documentMode>7||e.name in CKEDITOR.dtd.tr||e.name in CKEDITOR.dtd.$listItem))return!1;var i=n(e);return!i||i&&(i.type==CKEDITOR.NODE_ELEMENT&&i.name=="br"||e.name=="form"&&i.name=="input")}function o(e,t){return function(n){i(n,!e),s(n,!e,t)&&(e||CKEDITOR.env.ie?n.add(new CKEDITOR.htmlParser.text("Â ")):n.add(new CKEDITOR.htmlParser.element("br",{})))}}function d(e){var t=e.attributes;t.contenteditable!="false"&&(t["data-cke-editable"]=t.contenteditable?"true":1),t.contenteditable="false"}function v(e){var t=e.attributes;switch(t["data-cke-editable"]){case"true":t.contenteditable="true";break;case"1":delete t.contenteditable}}function x(e){return e.replace(m,function(e,t,n){return"<"+t+n.replace(g,function(e,t){return!/^on/.test(t)&&n.indexOf("data-cke-saved-"+t)==-1?" data-cke-saved-"+e+" data-cke-"+CKEDITOR.rnd+"-"+e:e})+">"})}function T(e){return e.replace(y,function(e){return"<cke:encoded>"+encodeURIComponent(e)+"</cke:encoded>"})}function N(e){return e.replace(b,function(e,t){return decodeURIComponent(t)})}function C(e){return e.replace(w,"$1cke:$2")}function k(e){return e.replace(E,"$1$2")}function L(e){return e.replace(S,"<cke:$1$2></cke:$1>")}function A(e){return e.replace(/(<pre\b[^>]*>)(\r\n|\n)/g,"$1$2$2")}function O(e){return e.replace(/<!--(?!{cke_protected})[\s\S]+?-->/g,function(e){return"<!--"+t+"{C}"+encodeURIComponent(e).replace(/--/g,"%2D%2D")+"-->"})}function M(e){return e.replace(/<!--\{cke_protected\}\{C\}([\s\S]+?)-->/g,function(e,t){return decodeURIComponent(t)})}function _(e,t){var n=t._.dataStore;return e.replace(/<!--\{cke_protected\}([\s\S]+?)-->/g,function(e,t){return decodeURIComponent(t)}).replace(/\{cke_protected_(\d+)\}/g,function(e,t){return n&&n[t]||""})}function D(e,n){var r=[],i=n.config.protectedSource,s=n._.dataStore||(n._.dataStore={id:1}),o=/<\!--\{cke_temp(comment)?\}(\d*?)-->/g,u=[/<script[\s\S]*?<\/script>/gi,/<noscript[\s\S]*?<\/noscript>/gi].concat(i);e=e.replace(/<!--[\s\S]*?-->/g,function(e){return"<!--{cke_tempcomment}"+(r.push(e)-1)+"-->"});for(var a=0;a<u.length;a++)e=e.replace(u[a],function(e){return e=e.replace(o,function(e,t,n){return r[n]}),/cke_temp(comment)?/.test(e)?e:"<!--{cke_temp}"+(r.push(e)-1)+"-->"});return e=e.replace(o,function(e,n,i){return"<!--"+t+(n?"{C}":"")+encodeURIComponent(r[i]).replace(/--/g,"%2D%2D")+"-->"}),e.replace(/(['"]).*?\1/g,function(e){return e.replace(/<!--\{cke_protected\}([\s\S]+?)-->/g,function(e,t){return s[s.id]=decodeURIComponent(t),"{cke_protected_"+s.id++ +"}"})})}var e=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,t="{cke_protected}",u=CKEDITOR.dtd,a=["caption","colgroup","col","thead","tfoot","tbody"],f=CKEDITOR.tools.extend({},u.$block,u.$listItem,u.$tableContent);for(var l in f)"br"in u[l]||delete f[l];delete f.pre;var c={elements:{},attributeNames:[[/^on/,"data-cke-pa-on"]]},h={elements:{}};for(l in f)h.elements[l]=o();var p={elementNames:[[/^cke:/,""],[/^\?xml:namespace$/,""]],attributeNames:[[/^data-cke-(saved|pa)-/,""],[/^data-cke-.*/,""],["hidefocus",""]],elements:{$:function(e){var t=e.attributes;if(t){if(t["data-cke-temp"])return!1;var n=["name","href","src"],r;for(var i=0;i<n.length;i++)r="data-cke-saved-"+n[i],r in t&&delete t[n[i]]}return e},table:function(e){var t=e.children.slice(0);t.sort(function(e,t){var n,i;return e.type==CKEDITOR.NODE_ELEMENT&&t.type==e.type&&(n=CKEDITOR.tools.indexOf(a,e.name),i=CKEDITOR.tools.indexOf(a,t.name)),n>-1&&i>-1&&n!=i||(n=r(e),i=r(t)),n>i?1:-1})},embed:function(e){var t=e.parent;if(t&&t.name=="object"){var n=t.attributes.width,r=t.attributes.height;n&&(e.attributes.width=n),r&&(e.attributes.height=r)}},param:function(e){return e.children=[],e.isEmpty=!0,e},a:function(e){if(!(e.children.length||e.attributes.name||e.attributes["data-cke-saved-name"]))return!1},span:function(e){e.attributes["class"]=="Apple-style-span"&&delete e.name},pre:function(e){CKEDITOR.env.ie&&i(e)},html:function(e){delete e.attributes.contenteditable,delete e.attributes["class"]},body:function(e){delete e.attributes.spellcheck,delete e.attributes.contenteditable},style:function(e){var t=e.children[0];t&&t.value&&(t.value=CKEDITOR.tools.trim(t.value)),e.attributes.type||(e.attributes.type="text/css")},title:function(e){var t=e.children[0];t&&(t.value=e.attributes["data-cke-title"]||"")}},attributes:{"class":function(e,t){return CKEDITOR.tools.ltrim(e.replace(/(?:^|\s+)cke_[^\s]*/g,""))||!1}}};CKEDITOR.env.ie&&(p.attributes.style=function(e,t){return e.replace(/(^|;)([^\:]+)/g,function(e){return e.toLowerCase()})});for(l in{input:1,textarea:1})c.elements[l]=d,p.elements[l]=v;var m=/<(a|area|img|input|source)\b([^>]*)>/gi,g=/\b(on\w+|href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,y=/(?:<style(?=[ >])[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,b=/<cke:encoded>([^<]*)<\/cke:encoded>/gi,w=/(<\/?)((?:object|embed|param|html|body|head|title)[^>]*>)/gi,E=/(<\/?)cke:((?:html|body|head|title)[^>]*>)/gi,S=/<cke:(param|embed)([^>]*?)\/?>(?!\s*<\/cke:\1)/gi;CKEDITOR.plugins.add("htmldataprocessor",{requires:["htmlwriter"],init:function(e){var t=e.dataProcessor=new CKEDITOR.htmlDataProcessor(e);t.writer.forceSimpleAmpersand=e.config.forceSimpleAmpersand,t.dataFilter.addRules(c),t.dataFilter.addRules(h),t.htmlFilter.addRules(p);var n={elements:{}};for(l in f)n.elements[l]=o(!0,e.config.fillEmptyBlocks);t.htmlFilter.addRules(n)},onLoad:function(){!("fillEmptyBlocks"in CKEDITOR.config)&&(CKEDITOR.config.fillEmptyBlocks=1)}}),CKEDITOR.htmlDataProcessor=function(e){this.editor=e,this.writer=new CKEDITOR.htmlWriter,this.dataFilter=new CKEDITOR.htmlParser.filter,this.htmlFilter=new CKEDITOR.htmlParser.filter},CKEDITOR.htmlDataProcessor.prototype={toHtml:function(e,t){e=D(e,this.editor),e=x(e),e=T(e),e=C(e),e=L(e),e=A(e);var n=new CKEDITOR.dom.element("div");n.setHtml("a"+e),e=n.getHtml().substr(1),e=e.replace(new RegExp(" data-cke-"+CKEDITOR.rnd+"-","ig")," "),e=k(e),e=N(e),e=M(e);var r=CKEDITOR.htmlParser.fragment.fromHtml(e,t),i=new CKEDITOR.htmlParser.basicWriter;return r.writeHtml(i,this.dataFilter),e=i.getHtml(!0),e=O(e),e},toDataFormat:function(e,t){var n=this.writer,r=CKEDITOR.htmlParser.fragment.fromHtml(e,t);n.reset(),r.writeHtml(n,this.htmlFilter);var i=n.getHtml(!0);return i=M(i),i=_(i,this.editor),i}}})();