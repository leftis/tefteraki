/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
/**
 * @file Justify commands.
 */
(function(){function e(e,t){t=t===undefined||t;var n;if(t)n=e.getComputedStyle("text-align");else{while(!e.hasAttribute||!e.hasAttribute("align")&&!e.getStyle("text-align")){var r=e.getParent();if(!r)break;e=r}n=e.getStyle("text-align")||e.getAttribute("align")||""}return n&&(n=n.replace(/(?:-(?:moz|webkit)-)?(?:start|auto)/i,"")),!n&&t&&(n=e.getComputedStyle("direction")=="rtl"?"right":"left"),n}function t(e){if(e.editor.readOnly)return;e.editor.getCommand(this.name).refresh(e.data.path)}function n(e,t,n){this.editor=e,this.name=t,this.value=n;var r=e.config.justifyClasses;if(r){switch(n){case"left":this.cssClassName=r[0];break;case"center":this.cssClassName=r[1];break;case"right":this.cssClassName=r[2];break;case"justify":this.cssClassName=r[3]}this.cssClassRegex=new RegExp("(?:^|\\s+)(?:"+r.join("|")+")(?=$|\\s)")}}function r(e){var t=e.editor,n=new CKEDITOR.dom.range(t.document);n.setStartBefore(e.data.node),n.setEndAfter(e.data.node);var r=new CKEDITOR.dom.walker(n),i;while(i=r.next())if(i.type==CKEDITOR.NODE_ELEMENT){if(!i.equals(e.data.node)&&i.getDirection()){n.setStartAfter(i),r=new CKEDITOR.dom.walker(n);continue}var s=t.config.justifyClasses;s&&(i.hasClass(s[0])?(i.removeClass(s[0]),i.addClass(s[2])):i.hasClass(s[2])&&(i.removeClass(s[2]),i.addClass(s[0])));var o="text-align",u=i.getStyle(o);u=="left"?i.setStyle(o,"right"):u=="right"&&i.setStyle(o,"left")}}n.prototype={exec:function(t){var n=t.getSelection(),r=t.config.enterMode;if(!n)return;var i=n.createBookmarks(),s=n.getRanges(!0),o=this.cssClassName,u,a,f=t.config.useComputedState;f=f===undefined||f;for(var l=s.length-1;l>=0;l--){u=s[l].createIterator(),u.enlargeBr=r!=CKEDITOR.ENTER_BR;while(a=u.getNextParagraph(r==CKEDITOR.ENTER_P?"p":"div")){a.removeAttribute("align"),a.removeStyle("text-align");var c=o&&(a.$.className=CKEDITOR.tools.ltrim(a.$.className.replace(this.cssClassRegex,""))),h=this.state==CKEDITOR.TRISTATE_OFF&&(!f||e(a,true)!=this.value);o?h?a.addClass(o):c||a.removeAttribute("class"):h&&a.setStyle("text-align",this.value)}}t.focus(),t.forceNextSelectionCheck(),n.selectBookmarks(i)},refresh:function(t){var n=t.block||t.blockLimit;this.setState(n.getName()!="body"&&e(n,this.editor.config.useComputedState)==this.value?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF)}},CKEDITOR.plugins.add("justify",{init:function(e){var i=new n(e,"justifyleft","left"),s=new n(e,"justifycenter","center"),o=new n(e,"justifyright","right"),u=new n(e,"justifyblock","justify");e.addCommand("justifyleft",i),e.addCommand("justifycenter",s),e.addCommand("justifyright",o),e.addCommand("justifyblock",u),e.ui.addButton("JustifyLeft",{label:e.lang.justify.left,command:"justifyleft"}),e.ui.addButton("JustifyCenter",{label:e.lang.justify.center,command:"justifycenter"}),e.ui.addButton("JustifyRight",{label:e.lang.justify.right,command:"justifyright"}),e.ui.addButton("JustifyBlock",{label:e.lang.justify.block,command:"justifyblock"}),e.on("selectionChange",CKEDITOR.tools.bind(t,i)),e.on("selectionChange",CKEDITOR.tools.bind(t,o)),e.on("selectionChange",CKEDITOR.tools.bind(t,s)),e.on("selectionChange",CKEDITOR.tools.bind(t,u)),e.on("dirChanged",r)},requires:["domiterator"]})})();