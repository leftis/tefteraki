/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
/**
 * @file Insert and remove numbered and bulleted lists.
 */
(function(){function o(e){var t,n,r;if(t=e.getDirection()){n=e.getParent();while(n&&!(r=n.getDirection()))n=n.getParent();t==r&&e.removeAttribute("dir")}}function u(e,t){var n=e.getAttribute("style");n&&t.setAttribute("style",n.replace(/([^;])$/,"$1;")+(t.getAttribute("style")||""))}function a(t){if(t.editor.readOnly)return null;var n=t.data.path,r=n.blockLimit,i=n.elements,s,o;for(o=0;o<i.length&&(s=i[o])&&!s.equals(r);o++)if(e[i[o].getName()])return this.setState(this.type==i[o].getName()?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF);return this.setState(CKEDITOR.TRISTATE_OFF)}function f(e,t,n,r){var i=CKEDITOR.plugins.list.listToArray(t.root,n),s=[];for(var o=0;o<t.contents.length;o++){var u=t.contents[o];u=u.getAscendant("li",!0);if(!u||u.getCustomData("list_item_processed"))continue;s.push(u),CKEDITOR.dom.element.setMarker(n,u,"list_item_processed",!0)}var a=t.root,f=a.getDocument(),l,c;for(o=0;o<s.length;o++){var h=s[o].getCustomData("listarray_index");l=i[h].parent,l.is(this.type)||(c=f.createElement(this.type),l.copyAttributes(c,{start:1,type:1}),c.removeStyle("list-style-type"),i[h].parent=c)}var p=CKEDITOR.plugins.list.arrayToList(i,n,null,e.config.enterMode),d,v=p.listNode.getChildCount();for(o=0;o<v&&(d=p.listNode.getChild(o));o++)d.getName()==this.type&&r.push(d);p.listNode.replace(t.root)}function c(e,t,n){var r=t.contents,i=t.root.getDocument(),s=[];if(r.length==1&&r[0].equals(t.root)){var o=i.createElement("div");r[0].moveChildren&&r[0].moveChildren(o),r[0].append(o),r[0]=o}var u=t.contents[0].getParent();for(var a=0;a<r.length;a++)u=u.getCommonAncestor(r[a].getParent());var f=e.config.useComputedState,c,h;f=f===undefined||f;for(a=0;a<r.length;a++){var p=r[a],d;while(d=p.getParent()){if(d.equals(u)){s.push(p),!h&&p.getDirection()&&(h=1);var v=p.getDirection(f);c!==null&&(c&&c!=v?c=null:c=v);break}p=d}}if(s.length<1)return;var m=s[s.length-1].getNext(),g=i.createElement(this.type);n.push(g);var y,b;while(s.length)y=s.shift(),b=i.createElement("li"),y.is("pre")||l.test(y.getName())?y.appendTo(b):(y.copyAttributes(b),c&&y.getDirection()&&(b.removeStyle("direction"),b.removeAttribute("dir")),y.moveChildren(b),y.remove()),b.appendTo(g);c&&h&&g.setAttribute("dir",c),m?g.insertBefore(m):g.appendTo(u)}function h(e,t,n){function v(n){(p=h[n?"getFirst":"getLast"]())&&(!p.is||!p.isBlockBoundary())&&(d=t.root[n?"getPrevious":"getNext"](CKEDITOR.dom.walker.whitespaces(!0)))&&(!d.is||!d.isBlockBoundary({br:1}))&&e.document.createElement("br")[n?"insertBefore":"insertAfter"](p)}var r=CKEDITOR.plugins.list.listToArray(t.root,n),i=[];for(var s=0;s<t.contents.length;s++){var o=t.contents[s];o=o.getAscendant("li",!0);if(!o||o.getCustomData("list_item_processed"))continue;i.push(o),CKEDITOR.dom.element.setMarker(n,o,"list_item_processed",!0)}var u=null;for(s=0;s<i.length;s++){var a=i[s].getCustomData("listarray_index");r[a].indent=-1,u=a}for(s=u+1;s<r.length;s++)if(r[s].indent>r[s-1].indent+1){var f=r[s-1].indent+1-r[s].indent,l=r[s].indent;while(r[s]&&r[s].indent>=l)r[s].indent+=f,s++;s--}var c=CKEDITOR.plugins.list.arrayToList(r,n,null,e.config.enterMode,t.root.getAttribute("dir")),h=c.listNode,p,d;v(!0),v(),h.replace(t.root)}function p(e,t){this.name=e,this.type=t}function v(e,t,n,r){var i,s;while(i=e[r?"getLast":"getFirst"](d))(s=i.getDirection(1))!==t.getDirection(1)&&i.setAttribute("dir",s),i.remove(),n?i[r?"insertBefore":"insertAfter"](n):t.append(i,r)}function m(e){var t;(t=function(t){var n=e[t?"getPrevious":"getNext"](i);n&&n.type==CKEDITOR.NODE_ELEMENT&&n.is(e.getName())&&(v(e,n,null,!t),e.remove(),e=n)})(),t(1)}function b(e,t){var n,r=e.children,i=r.length;for(var s=0;s<i;s++){n=r[s];if(n.name&&n.name in t)return s}return i}function w(e){return function(t){var n=t.children,r=b(t,g.$list),i=n[r],s=i&&i.previous,o;if(s&&(s.name&&s.name=="br"||s.value&&(o=s.value.match(y)))){var u=s;(!o||!o.index)&&u==n[0]?n[0]=e||CKEDITOR.env.ie?new CKEDITOR.htmlParser.text(" "):new CKEDITOR.htmlParser.element("br",{}):u.name=="br"?n.splice(r-1,1):u.value=u.value.replace(y,"")}}}function T(e){return e.type==CKEDITOR.NODE_ELEMENT&&(e.getName()in CKEDITOR.dtd.$block||e.getName()in CKEDITOR.dtd.$listItem)&&CKEDITOR.dtd[e.getName()]["#"]}function N(e,t,n){e.fire("saveSnapshot"),n.enlarge(CKEDITOR.ENLARGE_LIST_ITEM_CONTENTS);var r=n.extractContents();t.trim(!1,!0);var o=t.createBookmark(),u=new CKEDITOR.dom.elementPath(t.startContainer),a=u.block,f=u.lastElement.getAscendant("li",1)||a,l=new CKEDITOR.dom.elementPath(n.startContainer),c=l.contains(CKEDITOR.dtd.$listItem),h=l.contains(CKEDITOR.dtd.$list),p;if(a){var d=a.getBogus();d&&d.remove()}else h&&(p=h.getPrevious(i),p&&s(p)&&p.remove());p=r.getLast(),p&&p.type==CKEDITOR.NODE_ELEMENT&&p.is("br")&&p.remove();var g=t.startContainer.getChild(t.startOffset);g?r.insertBefore(g):t.startContainer.append(r);if(c){var y=C(c);y&&(f.contains(c)?(v(y,c.getParent(),c),y.remove()):f.append(y))}while(n.checkStartOfBlock()&&n.checkEndOfBlock()){l=new CKEDITOR.dom.elementPath(n.startContainer);var b=l.block,w;b.is("li")&&(w=b.getParent(),b.equals(w.getLast(i))&&b.equals(w.getFirst(i))&&(b=w)),n.moveToPosition(b,CKEDITOR.POSITION_BEFORE_START),b.remove()}var E=n.clone(),S=e.document.getBody();E.setEndAt(S,CKEDITOR.POSITION_BEFORE_END);var x=new CKEDITOR.dom.walker(E);x.evaluator=function(e){return i(e)&&!s(e)};var T=x.next();T&&T.type==CKEDITOR.NODE_ELEMENT&&T.getName()in CKEDITOR.dtd.$list&&m(T),t.moveToBookmark(o),t.select(),e.selectionChange(1),e.fire("saveSnapshot")}function C(t){var n=t.getLast(i);return n&&n.type==CKEDITOR.NODE_ELEMENT&&n.getName()in e?n:null}var e={ol:1,ul:1},t=/^[\n\r\t ]*$/,n=CKEDITOR.dom.walker.whitespaces(),r=CKEDITOR.dom.walker.bookmark(),i=function(e){return!n(e)&&!r(e)},s=CKEDITOR.dom.walker.bogus();CKEDITOR.plugins.list={listToArray:function(t,n,r,i,s){if(!e[t.getName()])return[];i||(i=0),r||(r=[]);for(var o=0,u=t.getChildCount();o<u;o++){var a=t.getChild(o);a.type==CKEDITOR.NODE_ELEMENT&&a.getName()in CKEDITOR.dtd.$list&&CKEDITOR.plugins.list.listToArray(a,n,r,i+1);if(a.$.nodeName.toLowerCase()!="li")continue;var f={parent:t,indent:i,element:a,contents:[]};s?f.grandparent=s:(f.grandparent=t.getParent(),f.grandparent&&f.grandparent.$.nodeName.toLowerCase()=="li"&&(f.grandparent=f.grandparent.getParent())),n&&CKEDITOR.dom.element.setMarker(n,a,"listarray_index",r.length),r.push(f);for(var l=0,c=a.getChildCount(),h;l<c;l++)h=a.getChild(l),h.type==CKEDITOR.NODE_ELEMENT&&e[h.getName()]?CKEDITOR.plugins.list.listToArray(h,n,r,i+1,f.grandparent):f.contents.push(h)}return r},arrayToList:function(t,n,r,s,a){r||(r=0);if(!t||t.length<r+1)return null;var f,l=t[r].parent.getDocument(),c=new CKEDITOR.dom.documentFragment(l),h=null,p=r,d=Math.max(t[r].indent,0),v=null,m,g,y=s==CKEDITOR.ENTER_P?"p":"div";for(;;){var b=t[p],w=b.grandparent;m=b.element.getDirection(1);if(b.indent==d){if(!h||t[p].parent.getName()!=h.getName())h=t[p].parent.clone(!1,1),a&&h.setAttribute("dir",a),c.append(h);v=h.append(b.element.clone(0,1)),m!=h.getDirection(1)&&v.setAttribute("dir",m);for(f=0;f<b.contents.length;f++)v.append(b.contents[f].clone(1,1));p++}else if(b.indent==Math.max(d,0)+1){var E=t[p-1].element.getDirection(1),S=CKEDITOR.plugins.list.arrayToList(t,null,p,s,E!=m?m:null);!v.getChildCount()&&CKEDITOR.env.ie&&!(l.$.documentMode>7)&&v.append(l.createText(" ")),v.append(S.listNode),p=S.nextIndex}else{if(b.indent!=-1||!!r||!w)return null;e[w.getName()]?(v=b.element.clone(!1,!0),m!=w.getDirection(1)&&v.setAttribute("dir",m)):v=new CKEDITOR.dom.documentFragment(l);var x=w.getDirection(1)!=m,T=b.element,N=T.getAttribute("class"),C=T.getAttribute("style"),k=v.type==CKEDITOR.NODE_DOCUMENT_FRAGMENT&&(s!=CKEDITOR.ENTER_BR||x||C||N),L,A=b.contents.length;for(f=0;f<A;f++)L=b.contents[f],L.type==CKEDITOR.NODE_ELEMENT&&L.isBlockBoundary()?(x&&!L.getDirection()&&L.setAttribute("dir",m),u(T,L),N&&L.addClass(N)):k&&(g||(g=l.createElement(y),x&&g.setAttribute("dir",m)),C&&g.setAttribute("style",C),N&&g.setAttribute("class",N),g.append(L.clone(1,1))),v.append(g||L.clone(1,1));if(v.type==CKEDITOR.NODE_DOCUMENT_FRAGMENT&&p!=t.length-1){var O=v.getLast();O&&O.type==CKEDITOR.NODE_ELEMENT&&O.getAttribute("type")=="_moz"&&O.remove(),(O=v.getLast(i)&&O.type==CKEDITOR.NODE_ELEMENT&&O.getName()in CKEDITOR.dtd.$block)||v.append(l.createElement("br"))}var M=v.$.nodeName.toLowerCase();!CKEDITOR.env.ie&&(M=="div"||M=="p")&&v.appendBogus(),c.append(v),h=null,p++}g=null;if(t.length<=p||Math.max(t[p].indent,0)<d)break}if(n){var _=c.getFirst(),D=t[0].parent;while(_)_.type==CKEDITOR.NODE_ELEMENT&&(CKEDITOR.dom.element.clearMarkers(n,_),_.getName()in CKEDITOR.dtd.$listItem&&o(_)),_=_.getNextSourceNode()}return{listNode:c,nextIndex:p}}};var l=/^h[1-6]$/,d=CKEDITOR.dom.walker.nodeType(CKEDITOR.NODE_ELEMENT);p.prototype={exec:function(t){var n=t.document,r=t.config,s=t.getSelection(),o=s&&s.getRanges(!0);if(!o||o.length<1)return;if(this.state==CKEDITOR.TRISTATE_OFF){var u=n.getBody();if(!u.getFirst(i))r.enterMode==CKEDITOR.ENTER_BR?u.appendBogus():o[0].fixBlock(1,r.enterMode==CKEDITOR.ENTER_P?"p":"div"),s.selectRanges(o);else{var a=o.length==1&&o[0],l=a&&a.getEnclosedNode();l&&l.is&&this.type==l.getName()&&this.setState(CKEDITOR.TRISTATE_ON)}}var p=s.createBookmarks(!0),d=[],v={},g=o.createIterator(),y=0;while((a=g.getNextRange())&&++y){var b=a.getBoundaryNodes(),w=b.startNode,E=b.endNode;w.type==CKEDITOR.NODE_ELEMENT&&w.getName()=="td"&&a.setStartAt(b.startNode,CKEDITOR.POSITION_AFTER_START),E.type==CKEDITOR.NODE_ELEMENT&&E.getName()=="td"&&a.setEndAt(b.endNode,CKEDITOR.POSITION_BEFORE_END);var S=a.createIterator(),x;S.forceBrBreak=this.state==CKEDITOR.TRISTATE_OFF;while(x=S.getNextParagraph()){if(x.getCustomData("list_block"))continue;CKEDITOR.dom.element.setMarker(v,x,"list_block",1);var T=new CKEDITOR.dom.elementPath(x),N=T.elements,C=N.length,k=null,L=0,A=T.blockLimit,O;for(var M=C-1;M>=0&&(O=N[M]);M--)if(e[O.getName()]&&A.contains(O)){A.removeCustomData("list_group_object_"+y);var _=O.getCustomData("list_group_object");_?_.contents.push(x):(_={root:O,contents:[x]},d.push(_),CKEDITOR.dom.element.setMarker(v,O,"list_group_object",_)),L=1;break}if(L)continue;var D=A;D.getCustomData("list_group_object_"+y)?D.getCustomData("list_group_object_"+y).contents.push(x):(_={root:D,contents:[x]},CKEDITOR.dom.element.setMarker(v,D,"list_group_object_"+y,_),d.push(_))}}var P=[];while(d.length>0)_=d.shift(),this.state==CKEDITOR.TRISTATE_OFF?e[_.root.getName()]?f.call(this,t,_,v,P):c.call(this,t,_,P):this.state==CKEDITOR.TRISTATE_ON&&e[_.root.getName()]&&h.call(this,t,_,v);for(M=0;M<P.length;M++)m(P[M]);CKEDITOR.dom.element.clearAllMarkers(v),s.selectBookmarks(p),t.focus()}};var g=CKEDITOR.dtd,y=/[\t\r\n ]*(?:&nbsp;|\xa0)$/,E={elements:{}};for(var S in g.$listItem)E.elements[S]=w();var x={elements:{}};for(S in g.$listItem)x.elements[S]=w(!0);CKEDITOR.plugins.add("list",{init:function(t){var n=t.addCommand("numberedlist",new p("numberedlist","ol")),r=t.addCommand("bulletedlist",new p("bulletedlist","ul"));t.ui.addButton("NumberedList",{label:t.lang.numberedlist,command:"numberedlist"}),t.ui.addButton("BulletedList",{label:t.lang.bulletedlist,command:"bulletedlist"}),t.on("selectionChange",CKEDITOR.tools.bind(a,n)),t.on("selectionChange",CKEDITOR.tools.bind(a,r)),t.on("key",function(n){var r=n.data.keyCode;if(t.mode=="wysiwyg"&&r in{8:1,46:1}){var o=t.getSelection(),u=o.getRanges()[0];if(!u.collapsed)return;var a=new CKEDITOR.dom.elementPath(u.startContainer),f=r==8,l=t.document.getBody(),c=new CKEDITOR.dom.walker(u.clone());c.evaluator=function(e){return i(e)&&!s(e)},c.guard=function(e,t){return!t||e.type!=CKEDITOR.NODE_ELEMENT||!e.is("table")};var h=u.clone();if(f){var p,d;(p=a.contains(e))&&u.checkBoundaryOfElement(p,CKEDITOR.START)&&(p=p.getParent())&&p.is("li")&&(p=C(p))?(d=p,p=p.getPrevious(i),h.moveToPosition(p&&s(p)?p:d,CKEDITOR.POSITION_BEFORE_START)):(c.range.setStartAt(l,CKEDITOR.POSITION_AFTER_START),c.range.setEnd(u.startContainer,u.startOffset),p=c.previous(),p&&p.type==CKEDITOR.NODE_ELEMENT&&(p.getName()in e||p.is("li"))&&(p.is("li")||(c.range.selectNodeContents(p),c.reset(),c.evaluator=T,p=c.previous()),d=p,h.moveToElementEditEnd(d)));if(d)N(t,h,u),n.cancel();else{var v=a.contains(e),m;v&&u.checkBoundaryOfElement(v,CKEDITOR.START)&&(m=v.getFirst(i),u.checkBoundaryOfElement(m,CKEDITOR.START)&&(p=v.getPrevious(i),C(m)?(p&&(u.moveToElementEditEnd(p),u.select()),n.cancel()):(t.execCommand("outdent"),n.cancel())))}}else{var g,y;m=u.startContainer.getAscendant("li",1);if(m){c.range.setEndAt(l,CKEDITOR.POSITION_BEFORE_END);var b=m.getLast(i),w=b&&T(b)?b:m,E=0;g=c.next(),g&&g.type==CKEDITOR.NODE_ELEMENT&&g.getName()in e&&g.equals(b)?(E=1,g=c.next()):u.checkBoundaryOfElement(w,CKEDITOR.END)&&(E=1),E&&g&&(y=u.clone(),y.moveToElementEditStart(g),N(t,h,y),n.cancel())}else c.range.setEndAt(l,CKEDITOR.POSITION_BEFORE_END),g=c.next(),g&&g.type==CKEDITOR.NODE_ELEMENT&&g.getName()in e&&(g=g.getFirst(i),a.block&&u.checkStartOfBlock()&&u.checkEndOfBlock()?(a.block.remove(),u.moveToElementEditStart(g),u.select(),n.cancel()):C(g)?(u.moveToElementEditStart(g),u.select(),n.cancel()):(y=u.clone(),y.moveToElementEditStart(g),N(t,h,y),n.cancel()))}setTimeout(function(){t.selectionChange(1)})}})},afterInit:function(e){var t=e.dataProcessor;t&&(t.dataFilter.addRules(E),t.htmlFilter.addRules(x))},requires:["domiterator"]})})();