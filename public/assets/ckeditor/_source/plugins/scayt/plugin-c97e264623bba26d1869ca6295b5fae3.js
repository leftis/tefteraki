/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
/**
 * @fileOverview Spell Check As You Type (SCAYT).
 * Button name : Scayt.
 */
(function(){function n(e,t){var n=0,r;for(r in t)if(t[r]==e){n=1;break}return n}var e="scaytcheck",t="",r=function(){var e=this,n=function(){var t=e.config,n={};n.srcNodeRef=e.document.getWindow().$.frameElement,n.assocApp="CKEDITOR."+CKEDITOR.version+"@"+CKEDITOR.revision,n.customerid=t.scayt_customerid||"1:WvF0D4-UtPqN1-43nkD4-NKvUm2-daQqk3-LmNiI-z7Ysb4-mwry24-T8YrS3-Q2tpq2",n.customDictionaryIds=t.scayt_customDictionaryIds||"",n.userDictionaryName=t.scayt_userDictionaryName||"",n.sLang=t.scayt_sLang||"en_US",n.onLoad=function(){CKEDITOR.env.ie&&CKEDITOR.env.version<8||this.addStyle(this.selectorCss(),"padding-bottom: 2px !important;"),e.focusManager.hasFocus&&!i.isControlRestored(e)&&this.focus()},n.onBeforeChange=function(){i.getScayt(e)&&!e.checkDirty()&&setTimeout(function(){e.resetDirty()},0)};var r=window.scayt_custom_params;if(typeof r=="object")for(var s in r)n[s]=r[s];i.getControlId(e)&&(n.id=i.getControlId(e));var o=new window.scayt(n);o.afterMarkupRemove.push(function(e){(new CKEDITOR.dom.element(e,o.document)).mergeSiblings()});var u=i.instances[e.name];u&&(o.sLang=u.sLang,o.option(u.option()),o.paused=u.paused),i.instances[e.name]=o;try{o.setDisabled(i.isPaused(e)===!1)}catch(a){}e.fire("showScaytState")};e.on("contentDom",n),e.on("contentDomUnload",function(){var e=CKEDITOR.document.getElementsByTag("script"),t=/^dojoIoScript(\d+)$/i,n=/^https?:\/\/svc\.webspellchecker\.net\/spellcheck\/script\/ssrv\.cgi/i;for(var r=0;r<e.count();r++){var i=e.getItem(r),s=i.getId(),o=i.getAttribute("src");s&&o&&s.match(t)&&o.match(n)&&i.remove()}}),e.on("beforeCommandExec",function(t){if(t.data.name!="source"&&t.data.name!="newpage"||e.mode!="wysiwyg")t.data.name=="source"&&e.mode=="source"&&i.markControlRestore(e);else{var n=i.getScayt(e);n&&(i.setPaused(e,!n.disabled),i.setControlId(e,n.id),n.destroy(!0),delete i.instances[e.name])}}),e.on("afterCommandExec",function(t){if(!i.isScaytEnabled(e))return;e.mode=="wysiwyg"&&(t.data.name=="undo"||t.data.name=="redo")&&window.setTimeout(function(){i.getScayt(e).refresh()},10)}),e.on("destroy",function(e){var t=e.editor,n=i.getScayt(t);if(!n)return;delete i.instances[t.name],i.setControlId(t,n.id),n.destroy(!0)}),e.on("afterSetData",function(){i.isScaytEnabled(e)&&window.setTimeout(function(){var t=i.getScayt(e);t&&t.refresh()},10)}),e.on("insertElement",function(){var t=i.getScayt(e);i.isScaytEnabled(e)&&(CKEDITOR.env.ie&&e.getSelection().unlock(!0),window.setTimeout(function(){t.focus(),t.refresh()},10))},this,null,50),e.on("insertHtml",function(){var t=i.getScayt(e);i.isScaytEnabled(e)&&(CKEDITOR.env.ie&&e.getSelection().unlock(!0),window.setTimeout(function(){t.focus(),t.refresh()},10))},this,null,50),e.on("scaytDialog",function(n){n.data.djConfig=window.djConfig,n.data.scayt_control=i.getScayt(e),n.data.tab=t,n.data.scayt=window.scayt});var r=e.dataProcessor,s=r&&r.htmlFilter;s&&s.addRules({elements:{span:function(e){if(e.attributes["data-scayt_word"]&&e.attributes["data-scaytid"])return delete e.name,e}}});var o=CKEDITOR.plugins.undo.Image.prototype;o.equals=CKEDITOR.tools.override(o.equals,function(e){return function(t){var n=this.contents,r=t.contents,s=i.getScayt(this.editor);s&&i.isScaytReady(this.editor)&&(this.contents=s.reset(n)||"",t.contents=s.reset(r)||"");var o=e.apply(this,arguments);return this.contents=n,t.contents=r,o}}),e.document&&n()};CKEDITOR.plugins.scayt={engineLoaded:!1,instances:{},controlInfo:{},setControlInfo:function(e,t){e&&e.name&&typeof this.controlInfo[e.name]!="object"&&(this.controlInfo[e.name]={});for(var n in t)this.controlInfo[e.name][n]=t[n]},isControlRestored:function(e){return e&&e.name&&this.controlInfo[e.name]?this.controlInfo[e.name].restored:!1},markControlRestore:function(e){this.setControlInfo(e,{restored:!0})},setControlId:function(e,t){this.setControlInfo(e,{id:t})},getControlId:function(e){return e&&e.name&&this.controlInfo[e.name]&&this.controlInfo[e.name].id?this.controlInfo[e.name].id:null},setPaused:function(e,t){this.setControlInfo(e,{paused:t})},isPaused:function(e){return e&&e.name&&this.controlInfo[e.name]?this.controlInfo[e.name].paused:undefined},getScayt:function(e){return this.instances[e.name]},isScaytReady:function(e){return this.engineLoaded===!0&&"undefined"!=typeof window.scayt&&this.getScayt(e)},isScaytEnabled:function(e){var t=this.getScayt(e);return t?t.disabled===!1:!1},getUiTabs:function(e){var t=[],n=e.config.scayt_uiTabs||"1,1,1";n=n.split(","),n[3]="1";for(var r=0;r<4;r++)t[r]=typeof window.scayt!="undefined"&&typeof window.scayt.uiTags!="undefined"?parseInt(n[r],10)&&window.scayt.uiTags[r]:parseInt(n[r],10);return t},loadEngine:function(e){if(CKEDITOR.env.gecko&&CKEDITOR.env.version<10900||CKEDITOR.env.opera||CKEDITOR.env.air)return e.fire("showScaytState");if(this.engineLoaded===!0)return r.apply(e);if(this.engineLoaded==-1)return CKEDITOR.on("scaytReady",function(){r.apply(e)});CKEDITOR.on("scaytReady",r,e),CKEDITOR.on("scaytReady",function(){this.engineLoaded=!0},this,null,0),this.engineLoaded=-1;var t=document.location.protocol;t=t.search(/https?:/)!=-1?t:"http:";var n="svc.webspellchecker.net/scayt26/loader__base.js",s=e.config.scayt_srcUrl||t+"//"+n,o=i.parseUrl(s).path+"/";return window.scayt==undefined?(CKEDITOR._djScaytConfig={baseUrl:o,addOnLoad:[function(){CKEDITOR.fireOnce("scaytReady")}],isDebug:!1},CKEDITOR.document.getHead().append(CKEDITOR.document.createElement("script",{attributes:{type:"text/javascript",async:"true",src:s}}))):CKEDITOR.fireOnce("scaytReady"),null},parseUrl:function(e){var t;return e.match&&(t=e.match(/(.*)[\/\\](.*?\.\w+)$/))?{path:t[1],file:t[2]}:e}};var i=CKEDITOR.plugins.scayt,s=function(e,t,n,r,i,s,o){e.addCommand(r,i),e.addMenuItem(r,{label:n,command:r,group:s,order:o})},o={preserveState:!0,editorFocus:!1,canUndo:!1,exec:function(e){if(i.isScaytReady(e)){var t=i.isScaytEnabled(e);this.setState(t?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_ON);var n=i.getScayt(e);n.focus(),n.setDisabled(t)}else!e.config.scayt_autoStartup&&i.engineLoaded>=0&&(this.setState(CKEDITOR.TRISTATE_DISABLED),i.loadEngine(e))}};CKEDITOR.plugins.add("scayt",{requires:["menubutton"],beforeInit:function(e){var t=e.config.scayt_contextMenuItemsOrder||"suggest|moresuggest|control",n="";t=t.split("|");if(t&&t.length)for(var r=0;r<t.length;r++)n+="scayt_"+t[r]+(t.length!=parseInt(r,10)+1?",":"");e.config.menu_groups=n+","+e.config.menu_groups},init:function(r){var u=r.dataProcessor&&r.dataProcessor.dataFilter,a={elements:{span:function(e){var t=e.attributes;t&&t["data-scaytid"]&&delete e.name}}};u&&u.addRules(a);var f={},l={},c=r.addCommand(e,o);CKEDITOR.dialog.add(e,CKEDITOR.getUrl(this.path+"dialogs/options.js"));var h=i.getUiTabs(r),p="scaytButton";r.addMenuGroup(p);var d={},v=r.lang.scayt;d.scaytToggle={label:v.enable,command:e,group:p},h[0]==1&&(d.scaytOptions={label:v.options,group:p,onClick:function(){t="options",r.openDialog(e)}}),h[1]==1&&(d.scaytLangs={label:v.langs,group:p,onClick:function(){t="langs",r.openDialog(e)}}),h[2]==1&&(d.scaytDict={label:v.dictionariesTab,group:p,onClick:function(){t="dictionaries",r.openDialog(e)}}),d.scaytAbout={label:r.lang.scayt.about,group:p,onClick:function(){t="about",r.openDialog(e)}},r.addMenuItems(d),r.ui.add("Scayt",CKEDITOR.UI_MENUBUTTON,{label:v.title,title:CKEDITOR.env.opera?v.opera_title:v.title,className:"cke_button_scayt",modes:{wysiwyg:1},onRender:function(){c.on("state",function(){this.setState(c.state)},this)},onMenu:function(){var e=i.isScaytEnabled(r);r.getMenuItem("scaytToggle").label=v[e?"disable":"enable"];var t=i.getUiTabs(r);return{scaytToggle:CKEDITOR.TRISTATE_OFF,scaytOptions:e&&t[0]?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,scaytLangs:e&&t[1]?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,scaytDict:e&&t[2]?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,scaytAbout:e&&t[3]?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED}}}),r.contextMenu&&r.addMenuItems&&r.contextMenu.addListener(function(e,t){if(!i.isScaytEnabled(r)||t.getRanges()[0].checkReadOnly())return null;var o=i.getScayt(r),u=o.getScaytNode();if(!u)return null;var a=o.getWord(u);if(!a)return null;var c=o.getLang(),h={},p=window.scayt.getSuggestion(a,c);if(!p||!p.length)return null;for(var d in f)delete r._.menuItems[d],delete r._.commands[d];for(d in l)delete r._.menuItems[d],delete r._.commands[d];f={},l={};var m=r.config.scayt_moreSuggestions||"on",g=!1,y=r.config.scayt_maxSuggestions;typeof y!="number"&&(y=5),!y&&(y=p.length);var b=r.config.scayt_contextCommands||"all";b=b.split("|");for(var w=0,E=p.length;w<E;w+=1){var S="scayt_suggestion_"+p[w].replace(" ","_"),x=function(e,t){return{exec:function(){o.replace(e,t)}}}(u,p[w]);w<y?(s(r,"button_"+S,p[w],S,x,"scayt_suggest",w+1),h[S]=CKEDITOR.TRISTATE_OFF,l[S]=CKEDITOR.TRISTATE_OFF):m=="on"&&(s(r,"button_"+S,p[w],S,x,"scayt_moresuggest",w+1),f[S]=CKEDITOR.TRISTATE_OFF,g=!0)}g&&(r.addMenuItem("scayt_moresuggest",{label:v.moreSuggestions,group:"scayt_moresuggest",order:10,getItems:function(){return f}}),l.scayt_moresuggest=CKEDITOR.TRISTATE_OFF);if(n("all",b)||n("ignore",b)){var T={exec:function(){o.ignore(u)}};s(r,"ignore",v.ignore,"scayt_ignore",T,"scayt_control",1),l.scayt_ignore=CKEDITOR.TRISTATE_OFF}if(n("all",b)||n("ignoreall",b)){var N={exec:function(){o.ignoreAll(u)}};s(r,"ignore_all",v.ignoreAll,"scayt_ignore_all",N,"scayt_control",2),l.scayt_ignore_all=CKEDITOR.TRISTATE_OFF}if(n("all",b)||n("add",b)){var C={exec:function(){window.scayt.addWordToUserDictionary(u)}};s(r,"add_word",v.addWord,"scayt_add_word",C,"scayt_control",3),l.scayt_add_word=CKEDITOR.TRISTATE_OFF}return o.fireOnContextMenu&&o.fireOnContextMenu(r),l});var m=function(){r.removeListener("showScaytState",m),!CKEDITOR.env.opera&&!CKEDITOR.env.air?c.setState(i.isScaytEnabled(r)?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF):c.setState(CKEDITOR.TRISTATE_DISABLED)};r.on("showScaytState",m),(CKEDITOR.env.opera||CKEDITOR.env.air)&&r.on("instanceReady",function(){m()}),r.config.scayt_autoStartup&&r.on("instanceReady",function(){i.loadEngine(r)})},afterInit:function(e){var t,n=function(e){if(e.hasAttribute("data-scaytid"))return!1};e._.elementsPath&&(t=e._.elementsPath.filters)&&t.push(n),e.addRemoveFormatFilter&&e.addRemoveFormatFilter(n)}})})();