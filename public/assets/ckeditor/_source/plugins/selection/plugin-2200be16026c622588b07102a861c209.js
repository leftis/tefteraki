/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
(function(){function e(){try{var e=this.getSelection();if(!e||!e.document.getWindow().$)return;var t=e.getStartElement(),n=new CKEDITOR.dom.elementPath(t);n.compare(this._.selectionPreviousPath)||(this._.selectionPreviousPath=n,this.fire("selectionChange",{selection:e,path:n,element:t}))}catch(r){}}function r(){n=!0;if(t)return;i.call(this),t=CKEDITOR.tools.setTimeout(i,200,this)}function i(){t=null,n&&(CKEDITOR.tools.setTimeout(e,0,this),n=!1)}function s(e){function t(t,n){if(!t||t.type==CKEDITOR.NODE_TEXT)return!1;var r=e.clone();return r["moveToElementEdit"+(n?"End":"Start")](t)}var n=e.startContainer,r=e.getPreviousNode(d,null,n),i=e.getNextNode(d,null,n);return t(r)||t(i,1)?!0:!r&&!i&&(n.type!=CKEDITOR.NODE_ELEMENT||!n.isBlockBoundary()||!n.getBogus())?!0:!1}function u(e){l(e);var t=e.createText("​");return e.setCustomData("cke-fillingChar",t),t}function a(e){return e&&e.getCustomData("cke-fillingChar")}function f(e){var t=e&&a(e);t&&(t.getCustomData("ready")?l(e):t.setCustomData("ready",1))}function l(e){var t=e&&e.removeCustomData("cke-fillingChar");if(t){var n,r=e.getSelection().getNative(),i=r&&r.type!="None"&&r.getRangeAt(0);if(t.getLength()>1&&i&&i.intersectsNode(t.$)){n=[r.anchorOffset,r.focusOffset];var s=r.anchorNode==t.$&&r.anchorOffset>0,o=r.focusNode==t.$&&r.focusOffset>0;s&&n[0]--,o&&n[1]--,c(r)&&n.unshift(n.pop())}t.setText(t.getText().replace(/\u200B/g,""));if(n){var u=r.getRangeAt(0);u.setStart(u.startContainer,n[0]),u.setEnd(u.startContainer,n[1]),r.removeAllRanges(),r.addRange(u)}}}function c(e){if(!e.isCollapsed){var t=e.getRangeAt(0);return t.setStart(e.anchorNode,e.anchorOffset),t.setEnd(e.focusNode,e.focusOffset),t.collapsed}}var t,n,o={modes:{wysiwyg:1,source:1},readOnly:CKEDITOR.env.ie||CKEDITOR.env.webkit,exec:function(e){switch(e.mode){case"wysiwyg":e.document.$.execCommand("SelectAll",!1,null),e.forceNextSelectionCheck(),e.selectionChange();break;case"source":var t=e.textarea.$;CKEDITOR.env.ie?t.createTextRange().execCommand("SelectAll"):(t.selectionStart=0,t.selectionEnd=t.value.length),t.focus()}},canUndo:!1};CKEDITOR.plugins.add("selection",{init:function(t){if(CKEDITOR.env.webkit){t.on("selectionChange",function(){f(t.document)}),t.on("beforeSetMode",function(){l(t.document)});var n,i;function s(){var e=t.document,r=a(e);if(r){var s=e.$.defaultView.getSelection();s.type=="Caret"&&s.anchorNode==r.$&&(i=1),n=r.getText(),r.setText(n.replace(/\u200B/g,""))}}function u(){var e=t.document,r=a(e);r&&(r.setText(n),i&&(e.$.defaultView.getSelection().setPosition(r.$,r.getLength()),i=0))}t.on("beforeUndoImage",s),t.on("afterUndoImage",u),t.on("beforeGetData",s,null,null,0),t.on("getData",u)}t.on("contentDom",function(){var e=t.document,n=CKEDITOR.document,i=e.getBody(),s=e.getDocumentElement();if(CKEDITOR.env.ie){var o,u,a=1;i.on("focusin",function(t){if(t.data.$.srcElement.nodeName!="BODY")return;var n=e.getCustomData("cke_locked_selection");if(n)n.unlock(1),n.lock();else if(o&&a){try{o.select()}catch(r){}o=null}}),i.on("focus",function(){u=1,v()}),i.on("beforedeactivate",function(e){if(e.data.$.toElement)return;u=0,a=1}),CKEDITOR.env.ie&&t.on("blur",function(){try{e.$.selection.empty()}catch(t){}}),s.on("mousedown",function(){a=0}),s.on("mouseup",function(){a=1});var f;i.on("mousedown",function(e){if(e.data.$.button==2){var n=t.document.$.selection;n.type=="None"&&(f=t.window.getScrollPosition())}d()}),i.on("mouseup",function(e){e.data.$.button==2&&f&&(t.document.$.documentElement.scrollLeft=f.x,t.document.$.documentElement.scrollTop=f.y),f=null,u=1,setTimeout(function(){v(!0)},0)}),i.on("keydown",d),i.on("keyup",function(){u=1,v()});if(e.$.compatMode!="BackCompat"){if(CKEDITOR.env.ie7Compat||CKEDITOR.env.ie6Compat){function c(e,t,n){try{e.moveToPoint(t,n)}catch(r){}}s.on("mousedown",function(e){function t(e){e=e.data.$;if(u){var t=i.$.createTextRange();c(t,e.x,e.y),u.setEndPoint(a.compareEndPoints("StartToStart",t)<0?"EndToEnd":"StartToStart",t),u.select()}}function r(){n.removeListener("mouseup",o),s.removeListener("mouseup",o)}function o(){s.removeListener("mousemove",t),r(),u.select()}e=e.data;if(e.getTarget().is("html")&&e.$.x<s.$.clientWidth&&e.$.y<s.$.clientHeight){var u=i.$.createTextRange();c(u,e.$.x,e.$.y);var a=u.duplicate();s.on("mousemove",t),n.on("mouseup",o),s.on("mouseup",o)}})}if(CKEDITOR.env.ie8){s.on("mousedown",function(e){e.data.getTarget().is("html")&&(n.on("mouseup",p),s.on("mouseup",p))});function h(){n.removeListener("mouseup",p),s.removeListener("mouseup",p)}function p(){h();var t=CKEDITOR.document.$.selection,n=t.createRange();t.type!="None"&&n.parentElement().ownerDocument==e.$&&n.select()}}}e.on("selectionchange",v);function d(){u=0}function v(e){if(u){var n=t.document,i=t.getSelection(),s=i&&i.getNative();if(e&&s&&s.type=="None"&&!n.$.queryCommandEnabled("InsertImage")){CKEDITOR.tools.setTimeout(v,50,this,!0);return}var a;if(s&&s.type&&s.type!="Control"&&(a=s.createRange())&&(a=a.parentElement())&&(a=a.nodeName)&&a.toLowerCase()in{input:1,textarea:1})return;try{o=s&&i.getRanges()[0]}catch(f){}r.call(t)}}}else e.on("mouseup",r,t),e.on("keyup",r,t),e.on("selectionchange",r,t);CKEDITOR.env.webkit&&e.on("keydown",function(e){var n=e.data.getKey();switch(n){case 13:case 33:case 34:case 35:case 36:case 37:case 39:case 8:case 45:case 46:l(t.document)}},null,null,-1)}),t.on("contentDomUnload",t.forceNextSelectionCheck,t),t.addCommand("selectAll",o),t.ui.addButton("SelectAll",{label:t.lang.selectAll,command:"selectAll"}),t.selectionChange=function(t){(t?e:r).call(this)},CKEDITOR.env.ie9Compat&&t.on("destroy",function(){var e=t.getSelection();e&&e.getNative().clear()},null,null,9)}}),CKEDITOR.editor.prototype.getSelection=function(){return this.document&&this.document.getSelection()},CKEDITOR.editor.prototype.forceNextSelectionCheck=function(){delete this._.selectionPreviousPath},CKEDITOR.dom.document.prototype.getSelection=function(){var e=new CKEDITOR.dom.selection(this);return!e||e.isInvalid?null:e},CKEDITOR.SELECTION_NONE=1,CKEDITOR.SELECTION_TEXT=2,CKEDITOR.SELECTION_ELEMENT=3,CKEDITOR.dom.selection=function(e){var t=e.getCustomData("cke_locked_selection");if(t)return t;this.document=e,this.isLocked=0,this._={cache:{}};if(CKEDITOR.env.ie)try{var n=this.getNative().createRange();if(!n||n.item&&n.item(0).ownerDocument!=this.document.$||n.parentElement&&n.parentElement().ownerDocument!=this.document.$)throw 0}catch(r){this.isInvalid=!0}return this};var h={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};CKEDITOR.dom.selection.prototype={getNative:CKEDITOR.env.ie?function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.$.selection)}:function(){return this._.cache.nativeSel||(this._.cache.nativeSel=this.document.getWindow().$.getSelection())},getType:CKEDITOR.env.ie?function(){var e=this._.cache;if(e.type)return e.type;var t=CKEDITOR.SELECTION_NONE;try{var n=this.getNative(),r=n.type;r=="Text"&&(t=CKEDITOR.SELECTION_TEXT),r=="Control"&&(t=CKEDITOR.SELECTION_ELEMENT),n.createRange().parentElement&&(t=CKEDITOR.SELECTION_TEXT)}catch(i){}return e.type=t}:function(){var e=this._.cache;if(e.type)return e.type;var t=CKEDITOR.SELECTION_TEXT,n=this.getNative();if(!n)t=CKEDITOR.SELECTION_NONE;else if(n.rangeCount==1){var r=n.getRangeAt(0),i=r.startContainer;i==r.endContainer&&i.nodeType==1&&r.endOffset-r.startOffset==1&&h[i.childNodes[r.startOffset].nodeName.toLowerCase()]&&(t=CKEDITOR.SELECTION_ELEMENT)}return e.type=t},getRanges:function(){var e=CKEDITOR.env.ie?function(){function e(e){return(new CKEDITOR.dom.node(e)).getIndex()}var t=function(t,n){t=t.duplicate(),t.collapse(n);var r=t.parentElement(),i=r.ownerDocument;if(!r.hasChildNodes())return{container:r,offset:0};var s=r.children,o,u,a=t.duplicate(),f=0,l=s.length-1,c=-1,h,p,d;while(f<=l){c=Math.floor((f+l)/2),o=s[c],a.moveToElementText(o),h=a.compareEndPoints("StartToStart",t);if(h>0)l=c-1;else{if(!(h<0)){if(CKEDITOR.env.ie9Compat&&o.tagName=="BR"){var v=i.defaultView.getSelection();return{container:v[n?"anchorNode":"focusNode"],offset:v[n?"anchorOffset":"focusOffset"]}}return{container:r,offset:e(o)}}f=c+1}}if(c==-1||c==s.length-1&&h<0){a.moveToElementText(r),a.setEndPoint("StartToStart",t),p=a.text.replace(/(\r\n|\r)/g,"\n").length,s=r.childNodes;if(!p)return o=s[s.length-1],o.nodeType!=CKEDITOR.NODE_TEXT?{container:r,offset:s.length}:{container:o,offset:o.nodeValue.length};var m=s.length;while(p>0&&m>0)u=s[--m],u.nodeType==CKEDITOR.NODE_TEXT&&(d=u,p-=u.nodeValue.length);return{container:d,offset:-p}}a.collapse(h>0?!0:!1),a.setEndPoint(h>0?"StartToStart":"EndToStart",t),p=a.text.replace(/(\r\n|\r)/g,"\n").length;if(!p)return{container:r,offset:e(o)+(h>0?0:1)};while(p>0)try{u=o[h>0?"previousSibling":"nextSibling"],u.nodeType==CKEDITOR.NODE_TEXT&&(p-=u.nodeValue.length,d=u),o=u}catch(g){return{container:r,offset:e(o)}}return{container:d,offset:h>0?-p:d.nodeValue.length+p}};return function(){var e=this.getNative(),n=e&&e.createRange(),r=this.getType(),i;if(!e)return[];if(r==CKEDITOR.SELECTION_TEXT){i=new CKEDITOR.dom.range(this.document);var s=t(n,!0);return i.setStart(new CKEDITOR.dom.node(s.container),s.offset),s=t(n),i.setEnd(new CKEDITOR.dom.node(s.container),s.offset),i.endContainer.getPosition(i.startContainer)&CKEDITOR.POSITION_PRECEDING&&i.endOffset<=i.startContainer.getIndex()&&i.collapse(),[i]}if(r==CKEDITOR.SELECTION_ELEMENT){var o=[];for(var u=0;u<n.length;u++){var a=n.item(u),f=a.parentNode,l=0;i=new CKEDITOR.dom.range(this.document);for(;l<f.childNodes.length&&f.childNodes[l]!=a;l++);i.setStart(new CKEDITOR.dom.node(f),l),i.setEnd(new CKEDITOR.dom.node(f),l+1),o.push(i)}return o}return[]}}():function(){var e=[],t,n=this.document,r=this.getNative();if(!r)return e;r.rangeCount||(t=new CKEDITOR.dom.range(n),t.moveToElementEditStart(n.getBody()),e.push(t));for(var i=0;i<r.rangeCount;i++){var s=r.getRangeAt(i);t=new CKEDITOR.dom.range(n),t.setStart(new CKEDITOR.dom.node(s.startContainer),s.startOffset),t.setEnd(new CKEDITOR.dom.node(s.endContainer),s.endOffset),e.push(t)}return e};return function(t){var n=this._.cache;if(n.ranges&&!t)return n.ranges;n.ranges||(n.ranges=new CKEDITOR.dom.rangeList(e.call(this)));if(t){var r=n.ranges;for(var i=0;i<r.length;i++){var s=r[i],o=s.getCommonAncestor();o.isReadOnly()&&r.splice(i,1);if(s.collapsed)continue;if(s.startContainer.isReadOnly()){var u=s.startContainer;while(u){if(u.is("body")||!u.isReadOnly())break;u.type==CKEDITOR.NODE_ELEMENT&&u.getAttribute("contentEditable")=="false"&&s.setStartAfter(u),u=u.getParent()}}var a=s.startContainer,f=s.endContainer,l=s.startOffset,c=s.endOffset,h=s.clone();a&&a.type==CKEDITOR.NODE_TEXT&&(l>=a.getLength()?h.setStartAfter(a):h.setStartBefore(a)),f&&f.type==CKEDITOR.NODE_TEXT&&(c?h.setEndAfter(f):h.setEndBefore(f));var p=new CKEDITOR.dom.walker(h);p.evaluator=function(e){if(e.type==CKEDITOR.NODE_ELEMENT&&e.isReadOnly()){var t=s.clone();return s.setEndBefore(e),s.collapsed&&r.splice(i--,1),e.getPosition(h.endContainer)&CKEDITOR.POSITION_CONTAINS||(t.setStartAfter(e),t.collapsed||r.splice(i+1,0,t)),!0}return!1},p.next()}}return n.ranges}}(),getStartElement:function(){var e=this._.cache;if(e.startElement!==undefined)return e.startElement;var t,n=this.getNative();switch(this.getType()){case CKEDITOR.SELECTION_ELEMENT:return this.getSelectedElement();case CKEDITOR.SELECTION_TEXT:var r=this.getRanges()[0];if(r){if(!r.collapsed){r.optimize();for(;;){var i=r.startContainer,s=r.startOffset;if(s!=(i.getChildCount?i.getChildCount():i.getLength())||!!i.isBlockBoundary())break;r.setStartAfter(i)}t=r.startContainer;if(t.type!=CKEDITOR.NODE_ELEMENT)return t.getParent();t=t.getChild(r.startOffset);if(!t||t.type!=CKEDITOR.NODE_ELEMENT)t=r.startContainer;else{var o=t.getFirst();while(o&&o.type==CKEDITOR.NODE_ELEMENT)t=o,o=o.getFirst()}}else t=r.startContainer,t.type!=CKEDITOR.NODE_ELEMENT&&(t=t.getParent());t=t.$}}return e.startElement=t?new CKEDITOR.dom.element(t):null},getSelectedElement:function(){var e=this._.cache;if(e.selectedElement!==undefined)return e.selectedElement;var t=this,n=CKEDITOR.tools.tryThese(function(){return t.getNative().createRange().item(0)},function(){var e,n,r=t.getRanges()[0],i=r.getCommonAncestor(1,1),s={table:1,ul:1,ol:1,dl:1};for(var o in s)if(e=i.getAscendant(o,1))break;if(e){var u=new CKEDITOR.dom.range(this.document);u.setStartAt(e,CKEDITOR.POSITION_AFTER_START),u.setEnd(r.startContainer,r.startOffset);var a=CKEDITOR.tools.extend(s,CKEDITOR.dtd.$listItem,CKEDITOR.dtd.$tableContent),f=new CKEDITOR.dom.walker(u),l=function(e,t){return function(n,r){if(n.type==CKEDITOR.NODE_TEXT&&(!CKEDITOR.tools.trim(n.getText())||n.getParent().data("cke-bookmark")))return!0;var i;if(n.type==CKEDITOR.NODE_ELEMENT){i=n.getName();if(i=="br"&&t&&n.equals(n.getParent().getBogus()))return!0;if(r&&i in a||i in CKEDITOR.dtd.$removeEmpty)return!0}return e.halted=1,!1}};f.guard=l(f),f.checkBackward()&&!f.halted&&(f=new CKEDITOR.dom.walker(u),u.setStart(r.endContainer,r.endOffset),u.setEndAt(e,CKEDITOR.POSITION_BEFORE_END),f.guard=l(f,1),f.checkForward()&&!f.halted&&(n=e.$))}if(!n)throw 0;return n},function(){var e=t.getRanges()[0],n,r;for(var i=2;i&&!((n=e.getEnclosedNode())&&n.type==CKEDITOR.NODE_ELEMENT&&h[n.getName()]&&(r=n));i--)e.shrink(CKEDITOR.SHRINK_ELEMENT);return r.$});return e.selectedElement=n?new CKEDITOR.dom.element(n):null},getSelectedText:function(){var e=this._.cache;if(e.selectedText!==undefined)return e.selectedText;var t="",n=this.getNative();return this.getType()==CKEDITOR.SELECTION_TEXT&&(t=CKEDITOR.env.ie?n.createRange().text:n.toString()),e.selectedText=t},lock:function(){this.getRanges(),this.getStartElement(),this.getSelectedElement(),this.getSelectedText(),this._.cache.nativeSel={},this.isLocked=1,this.document.setCustomData("cke_locked_selection",this)},unlock:function(e){var t=this.document,n=t.getCustomData("cke_locked_selection");if(n){t.setCustomData("cke_locked_selection",null);if(e){var r=n.getSelectedElement(),i=!r&&n.getRanges();this.isLocked=0,this.reset(),r?this.selectElement(r):this.selectRanges(i)}}if(!n||!e)this.isLocked=0,this.reset()},reset:function(){this._.cache={}},selectElement:function(e){if(this.isLocked){var t=new CKEDITOR.dom.range(this.document);t.setStartBefore(e),t.setEndAfter(e),this._.cache.selectedElement=e,this._.cache.startElement=e,this._.cache.ranges=new CKEDITOR.dom.rangeList(t),this._.cache.type=CKEDITOR.SELECTION_ELEMENT;return}t=new CKEDITOR.dom.range(e.getDocument()),t.setStartBefore(e),t.setEndAfter(e),t.select(),this.document.fire("selectionchange"),this.reset()},selectRanges:function(e){if(this.isLocked){this._.cache.selectedElement=null,this._.cache.startElement=e[0]&&e[0].getTouchedStartNode(),this._.cache.ranges=new CKEDITOR.dom.rangeList(e),this._.cache.type=CKEDITOR.SELECTION_TEXT;return}if(CKEDITOR.env.ie){if(e.length>1){var t=e[e.length-1];e[0].setEnd(t.endContainer,t.endOffset),e.length=1}e[0]&&e[0].select(),this.reset()}else{var n=this.getNative();if(!n)return;e.length&&(n.removeAllRanges(),CKEDITOR.env.webkit&&l(this.document));for(var r=0;r<e.length;r++){if(r<e.length-1){var i=e[r],o=e[r+1],a=i.clone();a.setStart(i.endContainer,i.endOffset),a.setEnd(o.startContainer,o.startOffset);if(!a.collapsed){a.shrink(CKEDITOR.NODE_ELEMENT,!0);var f=a.getCommonAncestor(),c=a.getEnclosedNode();if(f.isReadOnly()||c&&c.isReadOnly()){o.setStart(i.startContainer,i.startOffset),e.splice(r--,1);continue}}}var h=e[r],p=this.document.$.createRange(),d=h.startContainer;h.collapsed&&(CKEDITOR.env.opera||CKEDITOR.env.gecko&&CKEDITOR.env.version<10900)&&d.type==CKEDITOR.NODE_ELEMENT&&!d.getChildCount()&&d.appendText("");if(h.collapsed&&CKEDITOR.env.webkit&&s(h)){var v=u(this.document);h.insertNode(v);var m=v.getNext();m&&!v.getPrevious()&&m.type==CKEDITOR.NODE_ELEMENT&&m.getName()=="br"?(l(this.document),h.moveToPosition(m,CKEDITOR.POSITION_BEFORE_START)):h.moveToPosition(v,CKEDITOR.POSITION_AFTER_END)}p.setStart(h.startContainer.$,h.startOffset);try{p.setEnd(h.endContainer.$,h.endOffset)}catch(g){if(!(g.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0))throw g;h.collapse(1),p.setEnd(h.endContainer.$,h.endOffset)}n.addRange(p)}this.document.fire("selectionchange"),this.reset()}},createBookmarks:function(e){return this.getRanges().createBookmarks(e)},createBookmarks2:function(e){return this.getRanges().createBookmarks2(e)},selectBookmarks:function(e){var t=[];for(var n=0;n<e.length;n++){var r=new CKEDITOR.dom.range(this.document);r.moveToBookmark(e[n]),t.push(r)}return this.selectRanges(t),this},getCommonAncestor:function(){var e=this.getRanges(),t=e[0].startContainer,n=e[e.length-1].endContainer;return t.getCommonAncestor(n)},scrollIntoView:function(){var e=this.getStartElement();e.scrollIntoView()}};var p=CKEDITOR.dom.walker.whitespaces(!0),d=CKEDITOR.dom.walker.invisible(1),v=/\ufeff|\u00a0/,m={table:1,tbody:1,tr:1};CKEDITOR.dom.range.prototype.select=CKEDITOR.env.ie?function(e){var t=this.collapsed,n,r,i,s=this.getEnclosedNode();if(s)try{i=this.document.$.body.createControlRange(),i.addElement(s.$),i.select();return}catch(o){}(this.startContainer.type==CKEDITOR.NODE_ELEMENT&&this.startContainer.getName()in m||this.endContainer.type==CKEDITOR.NODE_ELEMENT&&this.endContainer.getName()in m)&&this.shrink(CKEDITOR.NODE_ELEMENT,!0);var u=this.createBookmark(),a=u.startNode,f;t||(f=u.endNode),i=this.document.$.body.createTextRange(),i.moveToElementText(a.$),i.moveStart("character",1);if(f){var l=this.document.$.body.createTextRange();l.moveToElementText(f.$),i.setEndPoint("EndToEnd",l),i.moveEnd("character",-1)}else{var c=a.getNext(p);n=!(c&&c.getText&&c.getText().match(v))&&(e||!a.hasPrevious()||a.getPrevious().is&&a.getPrevious().is("br")),r=this.document.createElement("span"),r.setHtml("&#65279;"),r.insertBefore(a),n&&this.document.createText("﻿").insertBefore(a)}this.setStartBefore(a),a.remove(),t?(n?(i.moveStart("character",-1),i.select(),this.document.$.selection.clear()):i.select(),this.moveToPosition(r,CKEDITOR.POSITION_BEFORE_START),r.remove()):(this.setEndBefore(f),f.remove(),i.select()),this.document.fire("selectionchange")}:function(){this.document.getSelection().selectRanges([this])}})();