/*
Copyright (c) 2003-2012, CKSource - Frederico Knabben. All rights reserved.
For licensing, see LICENSE.html or http://ckeditor.com/license
*/
(function(){function t(t){function s(t){if(r.length>0)return;t.type==CKEDITOR.NODE_ELEMENT&&e.test(t.getName())&&!t.getCustomData("selected_cell")&&(CKEDITOR.dom.element.setMarker(i,t,"selected_cell",!0),r.push(t))}var n=t.getRanges(),r=[],i={};for(var o=0;o<n.length;o++){var u=n[o];if(u.collapsed){var a=u.getCommonAncestor(),f=a.getAscendant("td",!0)||a.getAscendant("th",!0);f&&r.push(f)}else{var l=new CKEDITOR.dom.walker(u),c;l.guard=s;while(c=l.next()){var h=c.getAscendant("td")||c.getAscendant("th");h&&!h.getCustomData("selected_cell")&&(CKEDITOR.dom.element.setMarker(i,h,"selected_cell",!0),r.push(h))}}}return CKEDITOR.dom.element.clearAllMarkers(i),r}function n(e){var t=0,n=e.length-1,r={},i,s,o;while(i=e[t++])CKEDITOR.dom.element.setMarker(r,i,"delete_cell",!0);t=0;while(i=e[t++])if((s=i.getPrevious())&&!s.getCustomData("delete_cell")||(s=i.getNext())&&!s.getCustomData("delete_cell"))return CKEDITOR.dom.element.clearAllMarkers(r),s;return CKEDITOR.dom.element.clearAllMarkers(r),o=e[0].getParent(),(o=o.getPrevious())?o.getLast():(o=e[n].getParent(),(o=o.getNext())?o.getChild(0):null)}function r(e,n){var r=t(e),i=r[0],s=i.getAscendant("table"),o=i.getDocument(),u=r[0].getParent(),a=u.$.rowIndex,f=r[r.length-1],l=f.getParent().$.rowIndex+f.$.rowSpan-1,c=new CKEDITOR.dom.element(s.$.rows[l]),h=n?a:l,p=n?u:c,d=CKEDITOR.tools.buildTableMap(s),v=d[h],m=n?d[h-1]:d[h+1],g=d[0].length,y=o.createElement("tr");for(var b=0;v[b]&&b<g;b++){var w;v[b].rowSpan>1&&m&&v[b]==m[b]?(w=v[b],w.rowSpan+=1):(w=(new CKEDITOR.dom.element(v[b])).clone(),w.removeAttribute("rowSpan"),!CKEDITOR.env.ie&&w.appendBogus(),y.append(w),w=w.$),b+=w.colSpan-1}n?y.insertBefore(p):y.insertAfter(p)}function i(e){if(e instanceof CKEDITOR.dom.selection){var n=t(e),r=n[0],s=r.getAscendant("table"),o=CKEDITOR.tools.buildTableMap(s),u=n[0].getParent(),a=u.$.rowIndex,f=n[n.length-1],l=f.getParent().$.rowIndex+f.$.rowSpan-1,c=[];for(var h=a;h<=l;h++){var p=o[h],d=new CKEDITOR.dom.element(s.$.rows[h]);for(var v=0;v<p.length;v++){var m=new CKEDITOR.dom.element(p[v]),g=m.getParent().$.rowIndex;if(m.$.rowSpan==1)m.remove();else{m.$.rowSpan-=1;if(g==h){var y=o[h+1];y[v-1]?m.insertAfter(new CKEDITOR.dom.element(y[v-1])):(new CKEDITOR.dom.element(s.$.rows[h+1])).append(m,1)}}v+=m.$.colSpan-1}c.push(d)}var b=s.$.rows,w=new CKEDITOR.dom.element(b[l+1]||(a>0?b[a-1]:null)||s.$.parentNode);for(h=c.length;h>=0;h--)i(c[h]);return w}return e instanceof CKEDITOR.dom.element&&(s=e.getAscendant("table"),s.$.rows.length==1?s.remove():e.remove()),null}function s(e,t){var n=e.getParent(),r=n.$.cells,i=0;for(var s=0;s<r.length;s++){var o=r[s];i+=t?1:o.colSpan;if(o==e.$)break}return i-1}function o(e,t){var n=t?Infinity:0;for(var r=0;r<e.length;r++){var i=s(e[r],t);if(t?i<n:i>n)n=i}return n}function u(e,n){var r=t(e),i=r[0],s=i.getAscendant("table"),u=o(r,1),a=o(r),f=n?u:a,l=CKEDITOR.tools.buildTableMap(s),c=[],h=[],p=l.length;for(var d=0;d<p;d++){c.push(l[d][f]);var v=n?l[d][f-1]:l[d][f+1];h.push(v)}for(d=0;d<p;d++){var m;if(!c[d])continue;c[d].colSpan>1&&h[d]==c[d]?(m=c[d],m.colSpan+=1):(m=(new CKEDITOR.dom.element(c[d])).clone(),m.removeAttribute("colSpan"),!CKEDITOR.env.ie&&m.appendBogus(),m[n?"insertBefore":"insertAfter"].call(m,new CKEDITOR.dom.element(c[d])),m=m.$),d+=m.rowSpan-1}}function a(e){var n=t(e),r=n[0],i=n[n.length-1],s=r.getAscendant("table"),o=CKEDITOR.tools.buildTableMap(s),u,a,f=[];for(var l=0,c=o.length;l<c;l++)for(var h=0,p=o[l].length;h<p;h++)o[l][h]==r.$&&(u=h),o[l][h]==i.$&&(a=h);for(l=u;l<=a;l++)for(h=0;h<o.length;h++){var d=o[h],v=new CKEDITOR.dom.element(s.$.rows[h]),m=new CKEDITOR.dom.element(d[l]);m.$&&(m.$.colSpan==1?m.remove():m.$.colSpan-=1,h+=m.$.rowSpan-1,v.$.cells.length||f.push(v))}var g=s.$.rows[0]&&s.$.rows[0].cells,y=new CKEDITOR.dom.element(g[u]||(u?g[u-1]:s.$.parentNode));return f.length==c&&s.remove(),y}function f(e){var t=[],n=e[0]&&e[0].getAscendant("table"),r,i,s,o;for(r=0,i=e.length;r<i;r++)t.push(e[r].$.cellIndex);t.sort();for(r=1,i=t.length;r<i;r++)if(t[r]-t[r-1]>1){s=t[r-1]+1;break}s||(s=t[0]>0?t[0]-1:t[t.length-1]+1);var u=n.$.rows;for(r=0,i=u.length;r<i;r++){o=u[r].cells[s];if(o)break}return o?new CKEDITOR.dom.element(o):n.getPrevious()}function l(e,t){var n=e.getStartElement(),r=n.getAscendant("td",1)||n.getAscendant("th",1);if(!r)return;var i=r.clone();CKEDITOR.env.ie||i.appendBogus(),t?i.insertBefore(r):i.insertAfter(r)}function c(e){if(e instanceof CKEDITOR.dom.selection){var r=t(e),i=r[0]&&r[0].getAscendant("table"),s=n(r);for(var o=r.length-1;o>=0;o--)c(r[o]);s?p(s,!0):i&&i.remove()}else if(e instanceof CKEDITOR.dom.element){var u=e.getParent();u.getChildCount()==1?u.remove():e.remove()}}function h(e){var t=e.getBogus();t&&t.remove(),e.trim()}function p(e,t){var n=new CKEDITOR.dom.range(e.getDocument());n["moveToElementEdit"+(t?"End":"Start")](e)||(n.selectNodeContents(e),n.collapse(t?!1:!0)),n.select(!0)}function d(e,t,n){var r=e[t];if(typeof n=="undefined")return r;for(var i=0;r&&i<r.length;i++){if(n.is&&r[i]==n.$)return i;if(i==n)return new CKEDITOR.dom.element(r[i])}return n.is?-1:null}function v(e,t){var n=[];for(var r=0;r<e.length;r++){var i=e[r];n.push(i[t]),i[t].rowSpan>1&&(r+=i[t].rowSpan-1)}return n}function m(e,n,r){var i=t(e),s;if((n?i.length!=1:i.length<2)||(s=e.getCommonAncestor())&&s.type==CKEDITOR.NODE_ELEMENT&&s.is("table"))return!1;var o,u=i[0],a=u.getAscendant("table"),f=CKEDITOR.tools.buildTableMap(a),l=f.length,c=f[0].length,p=u.getParent().$.rowIndex,v=d(f,p,u);if(n){var m;try{var g=parseInt(u.getAttribute("rowspan"),10)||1,y=parseInt(u.getAttribute("colspan"),10)||1;m=f[n=="up"?p-g:n=="down"?p+g:p][n=="left"?v-y:n=="right"?v+y:v]}catch(b){return!1}if(!m||u.$==m)return!1;i[n=="up"||n=="left"?"unshift":"push"](new CKEDITOR.dom.element(m))}var w=u.getDocument(),E=p,S=0,x=0,T=!r&&new CKEDITOR.dom.documentFragment(w),N=0;for(var C=0;C<i.length;C++){o=i[C];var k=o.getParent(),L=o.getFirst(),A=o.$.colSpan,O=o.$.rowSpan,M=k.$.rowIndex,_=d(f,M,o);N+=A*O,x=Math.max(x,_-v+A),S=Math.max(S,M-p+O);if(!r){if(h(o),o.getChildren().count()){if(M!=E&&L&&(!L.isBlockBoundary||!L.isBlockBoundary({br:1}))){var D=T.getLast(CKEDITOR.dom.walker.whitespaces(!0));D&&(!D.is||!D.is("br"))&&T.append("br")}o.moveChildren(T)}C?o.remove():o.setHtml("")}E=M}if(!r){T.moveChildren(u),CKEDITOR.env.ie||u.appendBogus(),x>=c?u.removeAttribute("rowSpan"):u.$.rowSpan=S,S>=l?u.removeAttribute("colSpan"):u.$.colSpan=x;var P=new CKEDITOR.dom.nodeList(a.$.rows),H=P.count();for(C=H-1;C>=0;C--){var B=P.getItem(C);if(!B.$.cells.length){B.remove(),H++;continue}}return u}return S*x==N}function g(e,n){var r=t(e);if(r.length>1)return!1;if(n)return!0;var i=r[0],s=i.getParent(),o=s.getAscendant("table"),u=CKEDITOR.tools.buildTableMap(o),a=s.$.rowIndex,f=d(u,a,i),l=i.$.rowSpan,c,h,p,v;if(l>1){h=Math.ceil(l/2),p=Math.floor(l/2),v=a+h;var m=new CKEDITOR.dom.element(o.$.rows[v]),g=d(u,v),y;c=i.clone();for(var b=0;b<g.length;b++){y=g[b];if(y.parentNode==m.$&&b>f){c.insertBefore(new CKEDITOR.dom.element(y));break}y=null}y||m.append(c,!0)}else{p=h=1,m=s.clone(),m.insertAfter(s),m.append(c=i.clone());var w=d(u,a);for(var E=0;E<w.length;E++)w[E].rowSpan++}return CKEDITOR.env.ie||c.appendBogus(),i.$.rowSpan=h,c.$.rowSpan=p,h==1&&i.removeAttribute("rowSpan"),p==1&&c.removeAttribute("rowSpan"),c}function y(e,n){var r=t(e);if(r.length>1)return!1;if(n)return!0;var i=r[0],s=i.getParent(),o=s.getAscendant("table"),u=CKEDITOR.tools.buildTableMap(o),a=s.$.rowIndex,f=d(u,a,i),l=i.$.colSpan,c,h,p;if(l>1)h=Math.ceil(l/2),p=Math.floor(l/2);else{p=h=1;var m=v(u,f);for(var g=0;g<m.length;g++)m[g].colSpan++}return c=i.clone(),c.insertAfter(i),CKEDITOR.env.ie||c.appendBogus(),i.$.colSpan=h,c.$.colSpan=p,h==1&&i.removeAttribute("colSpan"),p==1&&c.removeAttribute("colSpan"),c}var e=/^(?:td|th)$/,b={thead:1,tbody:1,tfoot:1,td:1,tr:1,th:1};CKEDITOR.plugins.tabletools={requires:["table","dialog"],init:function(e){var n=e.lang.table;e.addCommand("cellProperties",new CKEDITOR.dialogCommand("cellProperties")),CKEDITOR.dialog.add("cellProperties",this.path+"dialogs/tableCell.js"),e.addCommand("tableDelete",{exec:function(e){var t=e.getSelection(),n=t&&t.getStartElement(),r=n&&n.getAscendant("table",1);if(!r)return;var i=r.getParent();i.getChildCount()==1&&!i.is("body","td","th")&&(r=i);var s=new CKEDITOR.dom.range(e.document);s.moveToPosition(r,CKEDITOR.POSITION_BEFORE_START),r.remove(),s.select()}}),e.addCommand("rowDelete",{exec:function(e){var t=e.getSelection();p(i(t))}}),e.addCommand("rowInsertBefore",{exec:function(e){var t=e.getSelection();r(t,!0)}}),e.addCommand("rowInsertAfter",{exec:function(e){var t=e.getSelection();r(t)}}),e.addCommand("columnDelete",{exec:function(e){var t=e.getSelection(),n=a(t);n&&p(n,!0)}}),e.addCommand("columnInsertBefore",{exec:function(e){var t=e.getSelection();u(t,!0)}}),e.addCommand("columnInsertAfter",{exec:function(e){var t=e.getSelection();u(t)}}),e.addCommand("cellDelete",{exec:function(e){var t=e.getSelection();c(t)}}),e.addCommand("cellMerge",{exec:function(e){p(m(e.getSelection()),!0)}}),e.addCommand("cellMergeRight",{exec:function(e){p(m(e.getSelection(),"right"),!0)}}),e.addCommand("cellMergeDown",{exec:function(e){p(m(e.getSelection(),"down"),!0)}}),e.addCommand("cellVerticalSplit",{exec:function(e){p(g(e.getSelection()))}}),e.addCommand("cellHorizontalSplit",{exec:function(e){p(y(e.getSelection()))}}),e.addCommand("cellInsertBefore",{exec:function(e){var t=e.getSelection();l(t,!0)}}),e.addCommand("cellInsertAfter",{exec:function(e){var t=e.getSelection();l(t)}}),e.addMenuItems&&e.addMenuItems({tablecell:{label:n.cell.menu,group:"tablecell",order:1,getItems:function(){var n=e.getSelection(),r=t(n);return{tablecell_insertBefore:CKEDITOR.TRISTATE_OFF,tablecell_insertAfter:CKEDITOR.TRISTATE_OFF,tablecell_delete:CKEDITOR.TRISTATE_OFF,tablecell_merge:m(n,null,!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_merge_right:m(n,"right",!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_merge_down:m(n,"down",!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_split_vertical:g(n,!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_split_horizontal:y(n,!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_properties:r.length>0?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED}}},tablecell_insertBefore:{label:n.cell.insertBefore,group:"tablecell",command:"cellInsertBefore",order:5},tablecell_insertAfter:{label:n.cell.insertAfter,group:"tablecell",command:"cellInsertAfter",order:10},tablecell_delete:{label:n.cell.deleteCell,group:"tablecell",command:"cellDelete",order:15},tablecell_merge:{label:n.cell.merge,group:"tablecell",command:"cellMerge",order:16},tablecell_merge_right:{label:n.cell.mergeRight,group:"tablecell",command:"cellMergeRight",order:17},tablecell_merge_down:{label:n.cell.mergeDown,group:"tablecell",command:"cellMergeDown",order:18},tablecell_split_horizontal:{label:n.cell.splitHorizontal,group:"tablecell",command:"cellHorizontalSplit",order:19},tablecell_split_vertical:{label:n.cell.splitVertical,group:"tablecell",command:"cellVerticalSplit",order:20},tablecell_properties:{label:n.cell.title,group:"tablecellproperties",command:"cellProperties",order:21},tablerow:{label:n.row.menu,group:"tablerow",order:1,getItems:function(){return{tablerow_insertBefore:CKEDITOR.TRISTATE_OFF,tablerow_insertAfter:CKEDITOR.TRISTATE_OFF,tablerow_delete:CKEDITOR.TRISTATE_OFF}}},tablerow_insertBefore:{label:n.row.insertBefore,group:"tablerow",command:"rowInsertBefore",order:5},tablerow_insertAfter:{label:n.row.insertAfter,group:"tablerow",command:"rowInsertAfter",order:10},tablerow_delete:{label:n.row.deleteRow,group:"tablerow",command:"rowDelete",order:15},tablecolumn:{label:n.column.menu,group:"tablecolumn",order:1,getItems:function(){return{tablecolumn_insertBefore:CKEDITOR.TRISTATE_OFF,tablecolumn_insertAfter:CKEDITOR.TRISTATE_OFF,tablecolumn_delete:CKEDITOR.TRISTATE_OFF}}},tablecolumn_insertBefore:{label:n.column.insertBefore,group:"tablecolumn",command:"columnInsertBefore",order:5},tablecolumn_insertAfter:{label:n.column.insertAfter,group:"tablecolumn",command:"columnInsertAfter",order:10},tablecolumn_delete:{label:n.column.deleteColumn,group:"tablecolumn",command:"columnDelete",order:15}}),e.contextMenu&&e.contextMenu.addListener(function(e,t){if(!e||e.isReadOnly())return null;while(e){if(e.getName()in b)return{tablecell:CKEDITOR.TRISTATE_OFF,tablerow:CKEDITOR.TRISTATE_OFF,tablecolumn:CKEDITOR.TRISTATE_OFF};e=e.getParent()}return null})},getSelectedCells:t},CKEDITOR.plugins.add("tabletools",CKEDITOR.plugins.tabletools)})(),CKEDITOR.tools.buildTableMap=function(e){var t=e.$.rows,n=-1,r=[];for(var i=0;i<t.length;i++){n++,!r[n]&&(r[n]=[]);var s=-1;for(var o=0;o<t[i].cells.length;o++){var u=t[i].cells[o];s++;while(r[n][s])s++;var a=isNaN(u.colSpan)?1:u.colSpan,f=isNaN(u.rowSpan)?1:u.rowSpan;for(var l=0;l<f;l++){r[n+l]||(r[n+l]=[]);for(var c=0;c<a;c++)r[n+l][s+c]=t[i].cells[o]}s+=a-1}}return r};